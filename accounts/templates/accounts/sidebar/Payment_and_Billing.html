{% load static %}
{% load bootstrap4 %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payment & Billing ' Customer Profile</title>

  <link href="https://fonts.googleapis.com/css2family=Inter:wght@400;600;700&family=Vesper+Libre:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/Payment_and_Billing.css' %}" />
  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <link rel="stylesheet" href="{% static 'css/customer_sidebar.css' %}">
<link rel="stylesheet" href="{% static 'css/main_header.css' %}">
</head>
<style>
   
</style>
<body>
<!-- HEADER -->
{% include "home/includes/main_header.html" %}

<div class="layout">
  <!-- Mobile header -->
  <div class="mobile-header">
    <button class="menu-toggle floating customer-menu-toggle" id="menuToggle">
      <span class="arrow">&#8250;</span>
    </button>
    <h2 class="mobile-title">Customer Profile</h2>
  </div>

  <!-- ===== Sidebar ===== -->
        {% include "accounts/includes/customer_sidebar.html" %}


  <!-- MAIN -->
  <main class="main">
    <h1>Payment & Billing</h1>

    <div class="page-grid">

      <!-- ' Payment methods (Django) -->
      <section class="card payment-methods-card">
        <div class="card-header">
          <h2>Payment Methods</h2>
          <a href="{% url 'accounts:Add_Payment_Method' %}">
            <button class="btn-icon" aria-label="Add payment method">+</button>
          </a>
        </div>

        <div class="payments-list">
          {% if payment_methods %}
            {% for pm in payment_methods %}
              <div class="payment-row">
                <div class="payment-left">

                  {% if pm.card_type == "visa" %}
                    <img src="{% static 'images/visa.png' %}" class="pm-icon">
                  {% elif pm.card_type == "mastercard" %}
                    <img src="{% static 'images/mastercard.png' %}" class="pm-icon">
                  {% elif pm.card_type == "amex" %}
                    <img src="{% static 'images/amex.png' %}" class="pm-icon">
                  {% elif pm.card_type == "discover" %}
                    <img src="{% static 'images/discover.png' %}" class="pm-icon">
                  {% endif %}

                  <div class="pm-text">
                    <div class="pm-title">
                      <strong>{{ pm.get_card_type_display }} &#9733;&#9733;&#9733;&#9733; {{ pm.card_last4 }}</strong>
                    </div>
                    <div class="pm-sub">Expires {{ pm.expiry_date }}</div>
                  </div>
                </div>

                <div class="payment-right">
                  {% if pm.is_default %}
                    <span class="btn-default state">Default</span>
                  {% else %}
                    <a href="{% url 'accounts:set_payment_default' pm.id %}" class="btn-default">
                      Set as default
                    </a>
                  {% endif %}

                  <a href="{% url 'accounts:delete_payment_method' pm.id %}"
                     class="icon-edit"
                     aria-label="Delete payment method"
                     onclick="return confirm('Delete this payment method')">
                    &times;
                  </a>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <p class="muted">No payment methods added yet.</p>
          {% endif %}
        </div>
      </section>

      <!-- ' Subscription (طھط±ظƒظ†ط§ظ‡ ظƒظ…ط§ ظ‡ظˆ) -->
      <aside class="card subscription-card">
        <h3>Subscription</h3>
        <div class="sub-box">
          {% if subscription.status == "cancelled" %}
            <p class="muted">Subscription cancelled.</p>
          {% else %}
            <p><strong>{{ subscription.display_title }}</strong></p>
            <p>Next charge: {{ subscription.next_billing_date|date:"M d, Y" }}</p>
            <p>Next service: {{ subscription.next_service_date|date:"M d, Y" }}</p>
          {% endif %}
          <div class="sub-actions">
            <button class="btn-outline" id="openSubscriptionModal" {% if subscription.status == "cancelled" %}disabled{% endif %}>Manage</button>
          </div>
        </div>
      </aside>

    </div>

    <!-- ' Invoice History -->
    <section class="card invoice-history">
      <h2>Invoice History</h2>
      <table id="invoiceTable">
        <thead>
          <tr>
            <th>Invoice #</th>
            <th>Date</th>
            <th>Amount</th>
            <th>Payment Method</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% if invoices %}
            {% for inv in invoices %}
              <tr>
                <td>{{ inv.invoice_number }}</td>
                <td>{{ inv.issued_at|date:"M d, Y" }}</td>
                <td>{{ inv.amount }} {{ inv.currency }}</td>
                <td>
                  {% if inv.payment_method %}
                    {{ inv.payment_method.get_card_type_display }} &#9733;&#9733;&#9733;&#9733; {{ inv.payment_method.card_last4 }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>
                  <span class="status {{ inv.status|lower }}">{{ inv.get_status_display }}</span>
                </td>
                <td><a href="#" class="muted">Download</a></td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="6" class="muted">No invoices yet.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </section>

  </main>
</div>

{% include "home/includes/footer.html" %}

<!-- Subscription Modals -->
<div class="modal-backdrop" id="subscriptionBackdrop"></div>

<div class="modal-sheet" id="subscriptionModal">
  <div class="modal-head">
    <h3>Manage Subscription</h3>
    <button class="icon-ghost modal-close" type="button" data-close="subscriptionModal">×</button>
  </div>
  <div class="modal-body">
    <div class="sub-summary">
      <div class="sub-title">{{ subscription.display_title }}</div>
      <div class="sub-meta">
        <span>Next Billing Date: {{ subscription.next_billing_date|date:"M d, Y" }}</span>
        <span>Next Service Date: {{ subscription.next_service_date|date:"M d, Y" }}</span>
      </div>
    </div>

    <form id="subscriptionForm">
      {% csrf_token %}
      <div class="form-row">
        <label class="switch-line">
          <input type="checkbox" name="skip_next_service" {% if subscription.skip_next_service %}checked{% endif %}>
          <span>Skip Next Service</span>
        </label>
      </div>

      <div class="form-row">
        <label class="check-line">
          <input type="checkbox" name="pause_subscription" id="pauseToggle" {% if subscription.is_paused %}checked{% endif %}>
          <span>Pause Subscription</span>
        </label>
        <div class="inline-grid" id="pauseFields">
          <div>
            <label>Pause until</label>
            <input type="date" name="pause_until" value="{{ subscription.pause_until|date:'Y-m-d' }}" class="form-control">
          </div>
          <div>
            <label>Resume on</label>
            <input type="date" name="resume_on" value="{{ subscription.resume_on|date:'Y-m-d' }}" class="form-control">
          </div>
        </div>
      </div>

      <div class="form-row">
        <label>Change Payment Method</label>
        <select name="payment_method" class="form-control">
          <option value="">Select a card</option>
          {% for pm in payment_methods %}
            <option value="{{ pm.id }}" {% if subscription.payment_method and subscription.payment_method.id == pm.id %}selected{% endif %}>
              {{ pm.get_card_type_display }} •••• {{ pm.card_last4 }}
            </option>
          {% endfor %}
        </select>
      </div>

      <button type="button" class="link-danger" id="openCancelModal">Cancel Subscription</button>

      <div class="modal-actions">
        <button type="button" class="btn btn-primary" id="reviewChangesBtn">Save Changes</button>
        <button type="button" class="btn btn-outline" data-close="subscriptionModal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<div class="modal-sheet modal-compact" id="reviewModal">
  <div class="modal-head">
    <h3>Review Changes</h3>
    <button class="icon-ghost modal-close" type="button" data-close="reviewModal">×</button>
  </div>
  <div class="modal-body">
    <ul class="review-list" id="reviewList"></ul>
    <p class="review-note">These changes will affect your upcoming billing and service schedule.</p>
    <div class="modal-actions">
      <button type="button" class="btn btn-primary" id="confirmChangesBtn">Confirm Changes</button>
      <button type="button" class="btn btn-outline" data-close="reviewModal">Cancel</button>
    </div>
  </div>
</div>

<div class="modal-sheet modal-compact" id="cancelModal">
  <div class="modal-head">
    <h3>Cancel subscription</h3>
    <button class="icon-ghost modal-close" type="button" data-close="cancelModal">×</button>
  </div>
  <div class="modal-body">
    <p class="muted">Your service will end after the next billing cycle.</p>
    <label>Why are you cancelling</label>
    <select id="cancelReason" class="form-control">
      <option value="">Select a reason</option>
      <option value="Too expensive">Too expensive</option>
      <option value="Not needed">Not needed</option>
      <option value="Moving">Moving</option>
      <option value="Other">Other</option>
    </select>
    <div class="modal-actions">
      <button type="button" class="btn btn-outline" data-close="cancelModal">Keep Subscription</button>
      <button type="button" class="btn btn-danger" id="confirmCancelBtn">Confirm Cancel</button>
    </div>
  </div>
</div>

<div class="modal-sheet modal-compact" id="savedModal">
  <div class="modal-head">
    <h3>Changes Saved</h3>
    <button class="icon-ghost modal-close" type="button" data-close="savedModal">×</button>
  </div>
  <div class="modal-body">
    <p>Your subscription has been updated successfully.</p>
    <div class="modal-actions">
      <button type="button" class="btn btn-primary" data-close="savedModal">Back</button>
    </div>
  </div>
</div>

<div class="modal-sheet modal-compact" id="cancelledModal">
  <div class="modal-head">
    <h3>Subscription Canceled</h3>
    <button class="icon-ghost modal-close" type="button" data-close="cancelledModal">×</button>
  </div>
  <div class="modal-body">
    <p>No further services will be scheduled. You can resubscribe anytime.</p>
    <div class="modal-actions">
      <button type="button" class="btn btn-primary" data-close="cancelledModal">Back</button>
    </div>
  </div>
</div>

<script>
(function () {
  const toggle = document.getElementById("menuToggle");
  const sidebar = document.querySelector(".sidebar");
  const overlay = document.querySelector(".customer-menu-overlay");
  if (!toggle || !sidebar) return;
  toggle.addEventListener("click", () => {
    const open = sidebar.classList.toggle("open");
    if (overlay) overlay.classList.toggle("show", open);
  });
  if (overlay) {
    overlay.addEventListener("click", () => {
      sidebar.classList.remove("open");
      overlay.classList.remove("show");
    });
  }
})();
</script>
<script>
(function () {
  const backdrop = document.getElementById("subscriptionBackdrop");
  const mainModal = document.getElementById("subscriptionModal");
  const reviewModal = document.getElementById("reviewModal");
  const cancelModal = document.getElementById("cancelModal");
  const savedModal = document.getElementById("savedModal");
  const cancelledModal = document.getElementById("cancelledModal");

  const openBtn = document.getElementById("openSubscriptionModal");
  const reviewBtn = document.getElementById("reviewChangesBtn");
  const confirmBtn = document.getElementById("confirmChangesBtn");
  const cancelBtn = document.getElementById("openCancelModal");
  const confirmCancelBtn = document.getElementById("confirmCancelBtn");

  const pauseToggle = document.getElementById("pauseToggle");
  const pauseFields = document.getElementById("pauseFields");
  const reviewList = document.getElementById("reviewList");
  const cancelReason = document.getElementById("cancelReason");
  const form = document.getElementById("subscriptionForm");

  function openModal(modal) {
    if (!modal || !backdrop) return;
    backdrop.classList.add("show");
    modal.classList.add("show");
  }

  function closeModal(modal) {
    if (!modal || !backdrop) return;
    modal.classList.remove("show");
    if (![mainModal, reviewModal, cancelModal, savedModal, cancelledModal].some(m => m && m.classList.contains("show"))) {
      backdrop.classList.remove("show");
    }
  }

  if (openBtn) {
    openBtn.addEventListener("click", () => openModal(mainModal));
  }

  document.querySelectorAll("[data-close]").forEach(btn => {
    btn.addEventListener("click", (e) => {
      const target = document.getElementById(e.currentTarget.dataset.close);
      closeModal(target);
    });
  });

  if (backdrop) {
    backdrop.addEventListener("click", () => {
      [mainModal, reviewModal, cancelModal, savedModal, cancelledModal].forEach(closeModal);
    });
  }

  function syncPauseFields() {
    if (!pauseFields) return;
    pauseFields.classList.toggle("show", pauseToggle && pauseToggle.checked);
  }
  if (pauseToggle) {
    pauseToggle.addEventListener("change", syncPauseFields);
    syncPauseFields();
  }

  if (reviewBtn) {
    reviewBtn.addEventListener("click", () => {
      if (!reviewList || !form) return;
      reviewList.innerHTML = "";
      const data = new FormData(form);
      const items = [];
      if (data.get("skip_next_service") === "on") items.push("Skip next service");
      if (data.get("pause_subscription") === "on") {
        items.push(`Pause until ${data.get("pause_until") || "-"}`);
        items.push(`Resume on ${data.get("resume_on") || "-"}`);
      }
      const pm = form.querySelector("select[name='payment_method']");
      if (pm && pm.value) items.push(`Payment method: ${pm.options[pm.selectedIndex].text}`);
      if (!items.length) items.push("No changes selected");
      items.forEach(text => {
        const li = document.createElement("li");
        li.textContent = text;
        reviewList.appendChild(li);
      });
      openModal(reviewModal);
    });
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
    return "";
  }

  if (confirmBtn) {
    confirmBtn.addEventListener("click", async () => {
      if (!form) return;
      const data = new FormData(form);
      data.append("action", "save");
      const res = await fetch("{% url 'accounts:manage_subscription' %}", {
        method: "POST",
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        body: data,
      });
      if (res.ok) {
        closeModal(reviewModal);
        closeModal(mainModal);
        openModal(savedModal);
      }
    });
  }

  if (cancelBtn) {
    cancelBtn.addEventListener("click", () => openModal(cancelModal));
  }

  if (confirmCancelBtn) {
    confirmCancelBtn.addEventListener("click", async () => {
      const data = new FormData();
      data.append("action", "cancel");
      data.append("cancel_reason", cancelReason  cancelReason.value : "");
      const res = await fetch("{% url 'accounts:manage_subscription' %}", {
        method: "POST",
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        body: data,
      });
      if (res.ok) {
        closeModal(cancelModal);
        closeModal(mainModal);
        openModal(cancelledModal);
      }
    });
  }
})();
</script>
<script src="{% static 'js/main_header.js' %}"></script>
</body>
</html>

