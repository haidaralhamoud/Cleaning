{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Service History & Ratings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <link rel="stylesheet" href="{% static 'css/Service_History_and_Ratings.css' %}">

  <style>
    .card { background:#fff; border-radius:16px; padding:30px; box-shadow:0 10px 30px rgba(0,0,0,.08); }
    .summary-grid { display:grid; grid-template-columns:220px 1fr; gap:30px; }
    .big-score { font-size:48px; font-weight:700; }
    .stars { color:#f6b100; font-size:20px; }
    .star-row { display:flex; align-items:center; gap:10px; margin-bottom:6px; }
    .star-bar { flex:1; height:8px; background:#eee; border-radius:8px; overflow:hidden; }
    .star-fill { height:100%; background:#12a3c7; }
    .metric-row { display:flex; align-items:center; gap:10px; margin:8px 0; }
    .metric-row .bar { flex:1; height:8px; background:#eee; border-radius:8px; overflow:hidden; }
    .metric-row .fill { height:100%; background:#12a3c7; }
    .btn { background:#12a3c7; color:#fff; padding:10px 20px; border-radius:20px; border:none; cursor:pointer; }
    .past-item { display:flex; justify-content:space-between; padding:15px 0; border-bottom:1px solid #eee; }
    .actions { display:flex; gap:10px; }
    .popup-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(2px);
      display: none;
    }

    .popup.show, .popup-overlay.show { display:block; }
    .close { float:right; cursor:pointer; font-size:20px; }
    .popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(.95);
  background: #fff;
  padding: 28px;
  border-radius: 18px;
  width: 380px;
  display: none;
  box-shadow: 0 25px 60px rgba(0,0,0,.25);
  animation: popupIn .25s ease forwards;
}

@keyframes popupIn {
  from { opacity:0; transform:translate(-50%,-45%) scale(.9); }
  to { opacity:1; transform:translate(-50%,-50%) scale(1); }
}

.popup h3 {
  margin-bottom: 15px;
  font-size: 20px;
  font-weight: 600;
}

.popup input,
.popup textarea {
  width: 100%;
  padding: 10px 12px;
  margin-bottom: 12px;
  border-radius: 10px;
  border: 1px solid #ddd;
  font-size: 14px;
}

.popup input:focus,
.popup textarea:focus {
  outline: none;
  border-color: #12a3c7;
  box-shadow: 0 0 0 2px rgba(18,163,199,.15);
}

.popup textarea {
  resize: none;
  min-height: 80px;
}

.close {
  position: absolute;
  top: 16px;
  right: 18px;
  cursor: pointer;
  font-size: 22px;
  color: #888;
}

.close:hover {
  color: #000;
}
.filters-bar {
  display: flex;
  gap: 14px;
  flex-wrap: wrap;
  align-items: center;
  margin: 25px 0;
}

.filter-box {
  display: flex;
  align-items: center;
  gap: 8px;
  background: #fff;
  padding: 10px 14px;
  border-radius: 14px;
  box-shadow: 0 6px 18px rgba(0,0,0,.08);
}

.filter-box .icon {
  font-size: 16px;
  opacity: .6;
}

.filter-box input,
.filter-box select {
  border: none;
  outline: none;
  font-size: 14px;
  background: transparent;
  min-width: 140px;
}

.filter-box.search input {
  min-width: 220px;
}

.apply-btn {
  background: #12a3c7;
  color: #fff;
  border: none;
  border-radius: 22px;
  padding: 11px 26px;
  font-size: 14px;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(18,163,199,.35);
  transition: .2s ease;
}

.apply-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 25px rgba(18,163,199,.45);
}

  </style>
</head>

<body>

<header class="main-header">
  <div class="logo">Hembla</div>
  <nav>
    <a href="/">HOME</a>
    <a href="#">ABOUT</a>
    <a href="#">SERVICES</a>
    <a href="#">PRICING</a>
    <a href="#">CONTACT</a>
  </nav>
  <a class="btn" href="#">My Profile</a>
</header>

<main class="content">

<h1>Service History & Ratings</h1>
<form method="get" class="filters-bar">

  <!-- üîç Search -->
  <div class="filter-box search">
    <span class="icon">üîç</span>
    <input
      type="text"
      name="q"
      placeholder="Search service history"
      value="{{ request.GET.q|default:'' }}"
    >
  </div>

  <!-- üìÖ Date From -->
  <div class="filter-box">
    <span class="icon">üìÖ</span>
    <input
      type="date"
      name="from"
      value="{{ request.GET.from|default:'' }}"
    >
  </div>

  <!-- üìÖ Date To -->
  <div class="filter-box">
    <span class="icon">üìÖ</span>
    <input
      type="date"
      name="to"
      value="{{ request.GET.to|default:'' }}"
    >
  </div>

  <!-- üßπ Service -->
  <div class="filter-box">
    <span class="icon">üßπ</span>
    <select name="service">
      <option value="">All Services</option>
      {% for s in service_types %}
        <option value="{{ s }}" {% if s == selected_service %}selected{% endif %}>
          {{ s }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- üë§ Provider -->
  <div class="filter-box">
    <span class="icon">üë§</span>
    <select name="provider">
      <option value="">All Providers</option>
      {% for p in providers %}
        <option value="{{ p.id }}" {% if request.GET.provider == p.id|stringformat:"s" %}selected{% endif %}>
          {{ p.get_full_name|default:p.username }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- ‚úÖ Apply -->
  <button class="apply-btn" type="submit">Apply</button>

</form>


<div class="card">

<h2>{{ selected_service }}</h2>

<div class="summary-grid">

  <div>
    <div class="big-score">{{ summary.avg_overall|floatformat:1 }}</div>
    <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
    <div>{{ summary.total }} reviews</div>
  </div>

  <div>
    {% for row in star_distribution %}
    <div class="star-row">
      <span>{{ row.star }}</span>
      <div class="star-bar">
        <div class="star-fill" style="width:{{ row.percent }}%"></div>
      </div>
      <span>{{ row.percent }}%</span>
    </div>
    {% endfor %}
  </div>

</div>

<hr>

<h4>Category Averages</h4>

<div class="metric-row">
  <span>Punctuality</span>
  <div class="bar"><div class="fill" style="width:{{ summary.avg_punctuality|floatformat:0 }}0%"></div></div>
  <span>{{ summary.avg_punctuality|floatformat:1 }}</span>
</div>

<div class="metric-row">
  <span>Quality</span>
  <div class="bar"><div class="fill" style="width:{{ summary.avg_quality|floatformat:0 }}0%"></div></div>
  <span>{{ summary.avg_quality|floatformat:1 }}</span>
</div>

<div class="metric-row">
  <span>Professionalism</span>
  <div class="bar"><div class="fill" style="width:{{ summary.avg_professionalism|floatformat:0 }}0%"></div></div>
  <span>{{ summary.avg_professionalism|floatformat:1 }}</span>
</div>

<div class="metric-row">
  <span>Value</span>
  <div class="bar"><div class="fill" style="width:{{ summary.avg_value|floatformat:0 }}0%"></div></div>
  <span>{{ summary.avg_value|floatformat:1 }}</span>
</div>

{% if can_leave_rating %}
  <button class="btn" onclick="openRating()">Leave Feedback</button>
{% endif %}

<hr>

<h3>Past Services</h3>

{% for s in past_services %}
<div class="past-item">
  <div>
    <strong>{{ s.service_title }}</strong><br>
    {{ s.date }}<br>
    {% if s.comment %}
      <small><b>Comment:</b> {{ s.comment }}</small>
    {% endif %}
  </div>

  <div class="actions">
    <a class="btn" href="{% url 'accounts:view_service_details' s.booking_type s.booking_id %}">View Details</a>
    {% if s.can_leave_comment %}
      <button class="btn" onclick="openComment('{{ s.booking_type }}','{{ s.booking_id }}')">Leave Comment</button>
    {% endif %}
  </div>
</div>
{% endfor %}

</div>
</main>

<!-- ================= RATING POPUP ================= -->
<div class="popup-overlay" id="overlay"></div>

<div class="popup" id="ratingPopup">
  <span class="close" onclick="closeAll()">√ó</span>
  <h3>Leave Feedback</h3>
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="form_type" value="rating">
    <input type="hidden" name="booking_type" value="{{ past_services.0.booking_type }}">
    <input type="hidden" name="booking_id" value="{{ past_services.0.booking_id }}">

    <input type="number" name="overall_rating" min="1" max="5" placeholder="Overall" required>
    <input type="number" name="punctuality" min="1" max="5" placeholder="Punctuality" required>
    <input type="number" name="quality" min="1" max="5" placeholder="Quality" required>
    <input type="number" name="professionalism" min="1" max="5" placeholder="Professionalism" required>
    <input type="number" name="value" min="1" max="5" placeholder="Value" required>
    <textarea name="feedback" placeholder="Optional feedback"></textarea>

    <button class="btn" type="submit">Save</button>
  </form>
</div>

<!-- ================= COMMENT POPUP ================= -->
<div class="popup" id="commentPopup">
  <span class="close" onclick="closeAll()">√ó</span>
  <h3>Leave Comment</h3>
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="form_type" value="comment">
    <input type="hidden" name="booking_type" id="c_type">
    <input type="hidden" name="booking_id" id="c_id">

    <textarea name="text" required></textarea>
    <button class="btn" type="submit">Save</button>
  </form>
</div>

<script>
function openRating(){
  document.getElementById("ratingPopup").classList.add("show");
  document.getElementById("overlay").classList.add("show");
}
function openComment(type,id){
  document.getElementById("c_type").value = type;
  document.getElementById("c_id").value = id;
  document.getElementById("commentPopup").classList.add("show");
  document.getElementById("overlay").classList.add("show");
}
function closeAll(){
  document.querySelectorAll(".popup").forEach(p=>p.classList.remove("show"));
  document.getElementById("overlay").classList.remove("show");
}
</script>
<script>
document.getElementById("overlay").addEventListener("click", closeAll);
</script>
</body>
</html>
