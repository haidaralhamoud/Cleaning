{% load static %}
{% load bootstrap4 %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loyalty & Rewards</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Vesper+Libre:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/Loyalty_and_Rewards.css' %}" />
  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <link rel="stylesheet" href="{% static 'css/customer_sidebar.css' %}">
  <link rel="stylesheet" href="{% static 'css/main_header.css' %}">

</head>
<body>
<!-- HEADER -->
{% include "home/includes/main_header.html" %}
  <div class="layout">

    <!-- ===== Mobile Header ===== -->
    <div class="mobile-header">
      <button class="menu-toggle floating customer-menu-toggle" id="menuToggle">
        <span class="arrow">&#8250;</span>
      </button>
      <h2 class="mobile-title">Customer Profile</h2>
    </div>

    <!-- ===== Sidebar ===== -->
    {% include "accounts/includes/customer_sidebar.html" %}


    <!-- ===== Main Content ===== -->
    <main class="main">
      <h1 class="page-title fade-in">Loyalty &amp; Rewards</h1>

      <section class="card fade-in" style="animation-delay:.05s">
        <div class="banner-sky"></div>

<!-- Points Balance -->
<div class="points-box">
  <div class="points-text">
    <small>Points Balance</small>
    <strong>{{ points_balance }}</strong>

    {% if next_tier %}
      <span>You're only {{ next_tier_points }} pts away from {{ next_tier.name }} Tier ًںژ‰</span>
    {% else %}
      <span>You're at the highest tier ًںژ‰</span>
    {% endif %}
  </div>

  <div class="tier-pill">
    {% if current_tier %}
      <b>{{ current_tier.name }} Member</b>
    {% endif %}
  </div>
</div>

        <!-- Tiers -->
        <h3 class="section-title">Tiers &amp; Status</h3>
        <div class="tiers">
          {% for tier in tiers %}
            <div class="tier {{ tier.color }} {% if current_tier and tier.id == current_tier.id %}active{% endif %}">
              <h4>{{ tier.name }}</h4>

              {% if tier.max_points %}
                <p>({{ tier.min_points }}â€“{{ tier.max_points }} pts)</p>
              {% else %}
                <p>(+ {{ tier.min_points }} pts)</p>
              {% endif %}

              <p>{{ tier.benefits }}</p>
            </div>
          {% endfor %}
        </div>



        <!-- Milestones -->
            <h3 class="section-title">Milestone Tracker</h3>
            <div class="milestones">

              <!-- Book 5 cleanings -->
              <div class="milestone">
                <div class="row">
                  <b>Book {{ book_5_target }} cleanings</b>
                  <small>{{ book_5_done }}/{{ book_5_target }}</small>
                </div>
                <div class="progress">
                  <span class="fill" data-pct="{{ book_5_percent }}"></span>
                </div>

                {% if book_5_done < book_5_target %}
                  <div class="hint">
                    Book {{ book_5_target|add:"-"|add:book_5_done }} more to unlock a Free Add-on!
                  </div>
                {% else %}
                  <div class="hint success">ًںژ‰ Milestone completed!</div>
                {% endif %}
              </div>

              <!-- Refer 3 friends -->
              <div class="milestone">
                <div class="row">
                  <b>Refer {{ refer_target }} friends</b>
                  <small>{{ refer_done }}/{{ refer_target }}</small>
                </div>
                <div class="progress">
                  <span class="fill" data-pct="{{ refer_percent }}"></span>
                </div>

                {% if refer_done < refer_target %}
                  <div class="hint">
                    Invite {{ refer_target|add:"-"|add:refer_done }} more friends to unlock a Free Service!
                  </div>
                {% else %}
                  <div class="hint success">ًںژ‰ Referral reward unlocked!</div>
                {% endif %}
              </div>

            </div>


        <!-- Rewards -->
        <h3 class="section-title">Available Rewards</h3>
        <div class="rewards">
          {% for r in rewards %}
            <div class="reward {% if not r.can_redeem %}locked{% endif %}">
              <div class="sub"
                  style="{% if r.can_redeem %}color:var(--sky-strong){% endif %}">
                {{ r.points_required }} points
              </div>

              <h5>{{ r.title }}</h5>
              <div class="desc">{{ r.description }}</div>

              {% if r.can_redeem %}
                <form method="post" action="{% url 'accounts:redeem_reward' r.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn">
                      Redeem Now
                    </button>
                  </form>
              {% else %}
                <button class="btn lock" disabled>
                  <img src="{% static 'images/lock0.png' %}" alt="">
                  Earn {{ r.missing_points }} more points
                </button>
              {% endif %}
            </div>
          {% endfor %}

        </div>

        <!-- Refer -->
        <div class="refer">
          <b>Refer a Friend &amp; Earn Big!</b>
          <div style="color:var(--sky-strong); font-weight:700; margin-top:4px;">
            Earn <span style="font-weight:900; font-size:18px;">500 pts</span> â€” your friend gets 10% off their first booking.
          </div>
          <div class="share-row">
            <a class="share wa" href="#"><img src="{% static 'images/whats-app0.png' %}" alt="">WhatsApp</a>
            <a class="share fb" href="#"><img src="{% static 'images/facebook1.png' %}" alt="">Facebook</a>
            <a class="share lk" href="#"><img src="{% static 'images/link0.png' %}" alt="">Copy Link</a>
          </div>
        </div>

        <!-- Activity -->
        <div class="grid-2">
          <div class="activity">
            <h3 class="section-title" style="margin-top:0">Available Rewards</h3>

            {% for t in transactions %}
              <div class="item">
                <div><b>{{ t.reason|default:"Points Update" }}</b></div>
                <small>{{ t.created_at|date:"F d, Y" }}</small>
                <div class="pts {% if t.amount > 0 %}green{% else %}red{% endif %}">
                  {% if t.amount > 0 %}+{% endif %}{{ t.amount }} pts
                </div>
              </div>
            {% empty %}
              <div class="item">
                <div><b>No Activity Yet</b></div>
                <small>â€”</small>
                <div class="pts">0 pts</div>
              </div>
            {% endfor %}
          </div>

            {% if promotion %}
        <div class="promo">
          <h3 class="section-title" style="margin-top:0">Promotions</h3>

          {% if promotion.image %}
            <img src="{{ promotion.image.url }}" alt="promotion">
          {% endif %}

          <h5>{{ promotion.title }}</h5>
          <p>{{ promotion.description }}</p>

          <button class="btn">
            ًںڑ€ Book Now & Earn x{{ promotion.points_multiplier }} Points
          </button>
        </div>

            {% endif %}

        </div>
      </section>
    </main>
  </div>

{% include "home/includes/footer.html" %}

<script src="{% static 'js/main_header.js' %}"></script>
  <script>
    window.addEventListener('load', ()=>{
      document.querySelectorAll('.progress .fill').forEach(el=>{
        const pct = +el.getAttribute('data-pct') || 0;
        requestAnimationFrame(()=> el.style.width = pct + '%');
      });
    });

    const toggle = document.getElementById("menuToggle");
    const sidebar = document.querySelector(".sidebar");
    const arrow = document.querySelector(".menu-toggle .arrow");

    toggle.addEventListener("click", () => {
      sidebar.classList.toggle("open");
      arrow.innerHTML = sidebar.classList.contains("open") ? "&#8249;" : "&#8250;";
    });
  </script>

</body>
</html>

