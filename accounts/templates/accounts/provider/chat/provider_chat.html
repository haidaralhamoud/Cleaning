{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Messages | Hembla</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <link rel="stylesheet" href="{% static 'css/main_header.css' %}">
  <link rel="stylesheet" href="{% static 'css/provider_portal.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    .chat-shell{
      max-width: 980px;
      margin: 30px auto 70px;
      padding: 0 22px;
    }

    .chat-card{
      background: #fff;
      border-radius: 22px;
      padding: 22px;
      border: 1px solid #e6eef3;
      box-shadow: var(--shadow);
    }

    .chat-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .chat-title{
      font-weight:800;
      font-size:22px;
    }

    .chat-thread{
      max-height: 420px;
      overflow-y: auto;
      padding: 10px 6px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .message{
      display:flex;
      flex-direction:column;
      max-width:70%;
      gap:6px;
    }

    .message.in{ align-self:flex-start; }
    .message.out{ align-self:flex-end; }

    .bubble{
      padding: 12px 16px;
      border-radius: 16px;
      line-height: 1.5;
      font-size:14px;
    }

    .message.in .bubble{
      background:#f1f7fb;
      border:1px solid #e4eef6;
      border-bottom-left-radius: 6px;
    }

    .message.out .bubble{
      background: linear-gradient(135deg, #00a3c8, #71b247);
      color:#fff;
      border-bottom-right-radius: 6px;
    }

    .meta{
      font-size:12px;
      color: var(--ink-500);
      display:flex;
      justify-content:space-between;
    }

    .composer{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:14px;
    }

    .composer input[type="text"]{
      flex:1;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid #dbe7ef;
    }

    .send-btn{
      background: var(--brand);
      color:#fff;
      border:none;
      padding: 10px 18px;
      border-radius: 12px;
      font-weight:700;
    }
  </style>
</head>

<body class="provider-portal">
{% include "home/includes/main_header.html" %}

<div class="chat-shell">
  <div class="chat-card">
    <div class="chat-head">
      <a class="pill" href="{% url 'accounts:provider_inbox' %}">
        <i class="fa-solid fa-arrow-left"></i> Back to Messages
      </a>
      <div>
        <div class="chat-title">Booking #{{ booking.id }}</div>
        <div class="muted">{{ booking_type|title }}</div>
      </div>
      <a class="pill primary" href="{% url 'accounts:provider_booking_detail' booking_type booking.id %}">
        View Order
      </a>
    </div>

    <hr style="border:none;border-top:1px solid #eef2f7;margin:14px 0;" />

    <div class="chat-thread" id="chatThread">
      {% for m in messages %}
        <article class="message {% if m.sender_id == request.user.id %}out{% else %}in{% endif %}">
          <div class="bubble">
            {{ m.text|linebreaksbr }}
            {% if m.file %}
              <div style="margin-top:6px;">
                <a href="{{ m.file.url }}" target="_blank">Attachment</a>
              </div>
            {% endif %}
          </div>
          <div class="meta">
            <span>{{ m.created_at|date:"h:i A" }}</span>
          </div>
        </article>
      {% empty %}
        <div class="empty-state" style="padding:40px 10px;">
          <div style="font-weight:800;">No messages</div>
          <div class="muted" style="margin-top:6px;">Start the conversation when you're ready.</div>
        </div>
      {% endfor %}
    </div>

    <form class="composer" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <label class="pill" style="padding:8px 12px;">
        <i class="fa-solid fa-paperclip"></i>
        <input type="file" name="file" hidden>
      </label>
      <input id="chat-input" name="message" type="text" placeholder="Type a message..." required>
      <button class="send-btn" type="submit">Send</button>
    </form>
  </div>
</div>

<script src="{% static 'js/main_header.js' %}"></script>
</body>
</html>
