{% load static %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">

<style>
.chat-card {
  background: #fff;
  border-radius: 16px;
  padding: 20px;
  max-width: 900px;
  margin: 30px auto;
  box-shadow: 0 10px 30px rgba(0,0,0,.08);
}

.chat-thread {
  max-height: 420px;
  overflow-y: auto;
  padding: 10px;
}

.message {
  margin-bottom: 14px;
  display: flex;
  flex-direction: column;
}

.message--out { align-items: flex-end; }
.message--in { align-items: flex-start; }

.message__bubble {
  padding: 12px 16px;
  border-radius: 18px;
  max-width: 70%;
  line-height: 1.4;
}

.message--out .message__bubble {
  background: #0d6efd;
  color: #fff;
  border-bottom-right-radius: 4px;
}

.message--in .message__bubble {
  background: #f1f1f1;
  border-bottom-left-radius: 4px;
}

.message__meta {
  font-size: 12px;
  opacity: .6;
  margin-top: 4px;
}

.composer {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  align-items: center;
}

.composer input {
  flex: 1;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid #ddd;
}

.icon-btn {
  background: none;
  border: none;
  font-size: 22px;
  cursor: pointer;
}

.send-btn {
  background: #0d6efd;
  color: #fff;
  border: none;
  padding: 10px 18px;
  border-radius: 12px;
}
</style>

<section class="chat-card">

  <!-- BACK -->
  <button class="back-btn" onclick="history.back()">â† Back</button>

  <h2>
    Booking #{{ booking.id }}
    {% if booking_type %} Â· {{ booking_type|title }} {% endif %}
  </h2>

  <hr style="border:none;border-top:1px solid #eee;margin:10px 0;" />

  <!-- THREAD -->
  <div class="chat-thread" id="chatThread">
    {% for m in messages %}
      <article class="message {% if m.sender_id == request.user.id %}message--out{% else %}message--in{% endif %}">
        <div class="message__bubble">
          {{ m.text|linebreaksbr }}
          {% if m.file %}
            <div><a href="{{ m.file.url }}" target="_blank">ğŸ“ Attachment</a></div>
          {% endif %}
        </div>
        <div class="message__meta">
          {{ m.created_at|date:"h:i A" }}
        </div>
      </article>
    {% empty %}
      <p style="opacity:.6;">No messages yetâ€¦</p>
    {% endfor %}
  </div>

  <!-- COMPOSER -->
  <form class="composer" method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <label class="icon-btn" title="Attach file">
      ğŸ“
      <input type="file" name="file" hidden>
    </label>

    <input
      id="chat-input"
      name="message"
      type="text"
      placeholder="Type a messageâ€¦"
      required
    >

<button type="button" id="emoji-btn" class="icon-btn">ğŸ˜Š</button>

<emoji-picker id="emoji-picker" style="
  display:none;
  position:absolute;
  bottom:60px;
  right:80px;
  z-index:999;
"></emoji-picker>


    <button class="send-btn" type="submit">Send</button>
  </form>

</section>

<!-- Emoji Library -->
<script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.4/dist/index.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const input  = document.getElementById("chat-input");
  const btn    = document.getElementById("emoji-btn");
  const picker = document.getElementById("emoji-picker");

  // ÙØªØ­ / Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
  btn.addEventListener("click", (e) => {
    e.stopPropagation(); // Ù…Ù‡Ù…
    picker.style.display =
      picker.style.display === "none" ? "block" : "none";
  });

  // Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
  picker.addEventListener("emoji-click", event => {
    input.value += event.detail.unicode;
    input.focus();
  });

  // ğŸ‘ˆ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
  document.addEventListener("click", (e) => {
    if (
      picker.style.display === "block" &&
      !picker.contains(e.target) &&
      !btn.contains(e.target)
    ) {
      picker.style.display = "none";
    }
  });

});
</script>

<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
