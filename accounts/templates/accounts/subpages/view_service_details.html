{% load static %}
{% load bootstrap4 %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customer Profile View</title>
  <link href="https://fonts.googleapis.com/css2?family=Vesper+Libre:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/view_service_details.css' %}" />
  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <link rel="stylesheet" href="{% static 'css/customer_sidebar.css' %}">
  <link rel="stylesheet" href="{% static 'css/main_header.css' %}">
</head>

<body class="customer-profile-view">
{% include "home/includes/main_header.html" %}
  <!-- ÿ≤ÿ± ÿßŸÑŸÖŸÜŸäŸà Ÿäÿ∏Ÿáÿ± ŸÅŸÇÿ∑ ÿ®ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ -->
  <button class="menu-toggle customer-menu-toggle" id="menuToggle">
    <span class="arrow">&#8250;</span>
  </button>

  <!-- Overlay ÿ™ÿ®ÿπ ÿßŸÑŸÖŸÜŸäŸà -->
  <div class="overlay customer-menu-overlay" id="menuOverlay"></div>

  <!-- Sidebar -->

    {% include "accounts/includes/customer_sidebar.html" with customer=booking.customer %}


  <!-- ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑŸÉÿßŸÖŸÑÿ© -->
  <main class="page">
    <section class="content">
      <h1 class="deep-clean-service">{{ service_title }}</h1>
      <p class="scheduled">
        Scheduled for
        {% if booking_date %}{{ booking_date|date:"F d, Y" }}{% else %}-{% endif %}
        {% if booking_time %} | {{ booking_time }}{% endif %}
        {% if location_text %} | location: {{ location_text }}{% endif %}
      </p>
      <p class="booking-id">
        Booking ID: #{{ booking.id }} |
        Payment method: {{ payment_method|default:"-" }} |
        Order type: {{ order_type_label }}
      </p>

      <div class="grid two-cols">
        <!-- ÿßŸÑÿπŸÖŸàÿØ ÿßŸÑŸäÿ≥ÿßÿ±Ÿä -->
        <div class="left-col">
    <div class="card timeline">
      <div class="track">

        {% for item in timeline %}
        <div class="stage
          {% if item.is_exception %}
            exception
          {% elif item.latest %}
            latest
          {% elif item.active %}
            done
          {% else %}
            pending
          {% endif %}
        ">

          <span class="dot"></span>

          <div class="info">
            <b>{{ item.label }}</b>

            {% if item.date %}
              <small>{{ item.date|date:"F d, Y ¬∑ h:i A" }}</small>
            {% else %}
              <small>Pending</small>
            {% endif %}

            {% if item.note %}
              <small>{{ item.note }}</small>
            {% endif %}
          </div>

        </div>
        {% endfor %}

      </div>

      <!-- ACTION BUTTONS -->
      <div class="timeline-actions">
{% if not hide_actions %}
  <button class="btn-reschedule" type="button" onclick="openPopup()">Reschedule</button>
  <button class="btn-cancel" type="button" onclick="openCancelPopup()">Cancel</button>
{% endif %}


      </div>
    </div>

<!-- ===== CANCEL BOOKING POPUP ===== -->
<div class="popup-overlay" id="cancelPopup">
  <form method="post"
        action="{% url 'accounts:cancel_booking' booking_type booking.id %}"
        class="popup cancel-popup">

    {% csrf_token %}

    <div class="cancel-header">
      <div class="cancel-icon">‚úï</div>
      <h2>Cancel Booking</h2>
    </div>

    <div class="cancel-body">
      <h4>Deep Clean Service</h4>
      <p class="time">Tomorrow, 9:00 AM ‚Äì 12:00 PM</p>

      <p class="warning">
        Cancellations within 12 hours of the service may incur a fee as per our policy.
      </p>

      <label class="label">Reason for cancellation</label>

      <div class="select-box">
        <select name="reason" id="cancelReason" required>
          <option value="" disabled selected>Select a Reason</option>
          <option value="change_of_plans">Change of plans</option>
          <option value="mistake">Booked by mistake</option>
          <option value="other_provider">Found another provider</option>
          <option value="emergency">Emergency</option>
        </select>
      </div>

      <div class="cancel-actions">
        <!-- CONFIRM -->
        <button type="submit" class="confirm-cancel">
          Confirm Cancellation
        </button>

        <!-- CLOSE -->
        <button type="button" class="cancel-back" onclick="closeCancelPopup()">
          Cancel
        </button>
      </div>
    </div>

  </form>
</div>


<!-- ===== RESCHEDULE POPUP ===== -->
<!-- ===== RESCHEDULE POPUP OVERLAY ===== -->
<div class="popup-overlay" id="reschedulePopup">

  <form method="post"
      action="{% url 'accounts:reschedule_booking' booking_type booking.id %}"
      class="popup reschedule-popup">
    {% csrf_token %}

    <!-- CLOSE BUTTON -->
    <button type="button" class="close-btn" onclick="closePopup()">√ó</button>

    <!-- ===== HEADER ===== -->
    <div class="popup-header">
      <div class="header-icon">
        <img src="{% static 'images/calendar-blue.png' %}" alt="Calendar">
      </div>

      <div class="header-text">
        <h2>Reschedule Service</h2>
        <p>Tomorrow, 9:00 AM ‚Äì 12:00 PM</p>
      </div>
    </div>

    <!-- ===== BODY ===== -->
    <div class="popup-body">

      <!-- DATE -->
      <label for="newDate">New Date</label>
      <input
        type="date"
        id="newDate"
        name="new_date"
        required
      >

      <!-- TIME -->
      <label for="newTime">Time</label>
      <input
        type="time"
        id="newTime"
        name="new_time"
        required
      >

      <!-- NOTE -->
      <p class="note">
        Note: You can reschedule up to 24h before service without extra charge
      </p>

      <!-- ACTIONS -->
      <div class="buttons">
        <button type="submit" class="primary">
          Confirm Reschedule
        </button>

        <button
          type="button"
          class="secondary"
          onclick="closePopup()">
          Cancel
        </button>
      </div>

    </div>
  </form>
</div>




<div class="card checklist">
  <h3>Checklist</h3>

  <form method="post" id="checklistForm">
    {% csrf_token %}
    <input type="hidden" name="form_type" value="checklist">

    <div class="check-grid">

      <!-- ===== LEFT COLUMN ===== -->
      <div class="check-col">

        <!-- Kitchen -->
        <h4>Kitchen</h4>

        <label>
          <input type="checkbox" name="kitchen_counters"
            {% if checklist_form.instance.kitchen_counters %}checked{% endif %}>
          Wipe counters & surfaces
        </label>

        <label>
          <input type="checkbox" name="kitchen_sink"
            {% if checklist_form.instance.kitchen_sink %}checked{% endif %}>
          Clean sink & faucet
        </label>

        <label>
          <input type="checkbox" name="kitchen_floor"
            {% if checklist_form.instance.kitchen_floor %}checked{% endif %}>
          Mop floor
        </label>

        <label>
          <input type="checkbox" name="kitchen_fridge"
            {% if checklist_form.instance.kitchen_fridge %}checked{% endif %}>
          Clean inside fridge (add-on)
        </label>

        <!-- Bathroom -->
        <h4>Bathroom</h4>

        <label>
          <input type="checkbox" name="bathroom_scrub"
            {% if checklist_form.instance.bathroom_scrub %}checked{% endif %}>
          Scrub toilet, sink, shower
        </label>

        <label>
          <input type="checkbox" name="bathroom_mirrors"
            {% if checklist_form.instance.bathroom_mirrors %}checked{% endif %}>
          Wipe mirrors & fixtures
        </label>

        <label>
          <input type="checkbox" name="bathroom_floor"
            {% if checklist_form.instance.bathroom_floor %}checked{% endif %}>
          Mop floor
        </label>

      </div>

      <!-- ===== RIGHT COLUMN ===== -->
      <div class="check-col">

        <!-- Bedrooms -->
        <h4>Bedrooms</h4>

        <label>
          <input type="checkbox" name="bedroom_beds"
            {% if checklist_form.instance.bedroom_beds %}checked{% endif %}>
          Make beds
        </label>

        <label>
          <input type="checkbox" name="bedroom_dust"
            {% if checklist_form.instance.bedroom_dust %}checked{% endif %}>
          Dust surfaces
        </label>

        <label>
          <input type="checkbox" name="bedroom_floor"
            {% if checklist_form.instance.bedroom_floor %}checked{% endif %}>
          Mop/vacuum floors
        </label>

        <!-- Living Room -->
        <h4>Living Room</h4>

        <label>
          <input type="checkbox" name="living_dust"
            {% if checklist_form.instance.living_dust %}checked{% endif %}>
          Dust furniture
        </label>

        <label>
          <input type="checkbox" name="living_vacuum"
            {% if checklist_form.instance.living_vacuum %}checked{% endif %}>
          Vacuum carpet
        </label>

        <label>
          <input type="checkbox" name="living_glass"
            {% if checklist_form.instance.living_glass %}checked{% endif %}>
          Wipe glass surfaces
        </label>

      </div>
    </div>

    <!-- Notes -->
    <div class="notes-field">
      <label>Notes</label>
      {{ checklist_form.notes }}

      <div class="end-actions">
        <button type="submit" class="btn btn-blue">Save</button>
      </div>
    </div>

  </form>
</div>


<div class="card notes-card">
  <h3>Notes</h3>

  <ul class="notes-list">
    {% for note in notes %}
      <li>
        <span class="dot green"></span>
        {{ note.text }}
        <small class="note-time">
          {{ note.created_at|date:"M d, H:i" }}
        </small>
      </li>
    {% empty %}
      <li class="muted">No notes yet.</li>
    {% endfor %}
  </ul>

  <!-- ÿ≤ÿ± + -->
  <button class="fab-plus" onclick="toggleNoteForm()">+</button>

  <!-- ÿßŸÑŸÅŸàÿ±ŸÖ ÿßŸÑŸÖÿÆŸÅŸä -->
  <form method="post" class="note-form" id="noteForm" style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="form_type" value="note">

    <textarea
      name="note_text"
      placeholder="Write your note..."
      required
    ></textarea>

    <button type="submit">Save</button>
  </form>
</div>


        </div>
<input type="hidden" id="bookingId" value="{{ booking.id }}">
<input type="hidden" id="bookingType" value="{{ booking_type }}">


        <!-- ÿßŸÑÿπŸÖŸàÿØ ÿßŸÑŸäŸÖŸäŸÜŸä -->
        <div class="right-col">
       <div class="card provider">
  <h3>Provider Assigned</h3>

  {% if booking.provider %}
    <div class="provider-row">
      <div class="avatar ellipse-1857"></div>
      <div>
        <b>
          {{ booking.provider.get_full_name|default:booking.provider.username }}
        </b>

        {% if booking.provider.profile %}
          <small>
            Rating: {{ booking.provider.profile.rating }}
            ({{ booking.provider.profile.reviews_count }} reviews)
          </small>
        {% else %}
          <small>No rating yet</small>
        {% endif %}
      </div>
    </div>
  {% else %}
    <p style="opacity:.6;">No provider assigned yet</p>
  {% endif %}
              <div class="provider-actions">
                <a href="{% url 'accounts:booking_chat' booking_type booking.id %}"
                  class="message-btn">

                  <span class="icon">üí¨</span>
                  <span class="text">Message</span>

                  {% if customer_unread_messages > 0 %}
                    <span class="msg-badge">{{ customer_unread_messages }}</span>
                  {% endif %}
                </a>

                {% if can_rate %}
                  <button type="button" class="rate-btn" onclick="openReviewPopup()">Rate</button>
                {% elif has_review %}
                  <span class="rated-tag">Rated</span>
                {% endif %}
              </div>



</div>

 
                <div class="card timing">
                  <h3>Time Tracking</h3>
                  <p><span class="muted">Quoted Time:</span> <b>{{ quoted_time }}</b></p>
                  <p>
                    <span class="muted">Actual Time:</span>
                    <b id="actualTime">
                      {% if actual_duration %}
                        {{ actual_duration }}
                      {% else %}
                        ‚Äî
                      {% endif %}
                    </b>
                  </p>
                  {% if start_time %}
                    <div id="timeData"
                         data-start="{{ start_time|date:'c' }}"
                         data-quoted="{{ quoted_seconds }}"
                         {% if end_time %}
                         data-end="{{ end_time|date:'c' }}"
                         {% endif %}>
                    </div>
                  {% endif %}
                </div>

          <div class="card charges">
            <h3>Charges</h3>
            <div class="rows">
              {% if booking.subtotal %}
                <div class="row"><span>Subtotal</span><span id="chargeSubtotal">{{ booking.subtotal }}$</span></div>
              {% endif %}
              {% if booking.rot_discount %}
                <div class="row"><span>Discount</span><span class="green" id="chargeDiscount">-{{ booking.rot_discount }}$</span></div>
              {% endif %}
              <div class="row"><span>Total</span><span id="chargeTotal">{{ booking.total_price }}$</span></div>
              <div class="row"><span>Payment Method</span><span>{{ payment_method|default:"-" }}</span></div>
            </div>
            <div class="total-row">
              <span class="blue">Total</span>
              <span class="blue" id="chargeTotalBottom">${{ booking.total_price }}</span>
            </div>
          </div>

          {% if booking_type == "private" %}
          <button type="button" class="pill request-addon" id="openAddonsPopup"><b>Request Add-on</b></button>
          {% else %}
          <a href="{% url 'accounts:Add_on_Service_Request' %}" class="see-more"><div class="pill request-addon"><b>Request Add-on</b></div></a>
          {% endif %}

               <!-- ===== MEDIA GALLERY ===== -->
          <div class="card media-gallery">
            <div class="media-header">
              <h3>Media Gallery</h3>
              <a href="{% url 'accounts:Media' %}?booking_type={{ booking_type }}&booking_id={{ booking.id }}" class="see-more">see more ‚Üí</a>
            </div>

            <div class="media-carousel">
              <button class="arrow-btn left">‚Äπ</button>
              <div class="media-track">
                {% if media_items %}
                  {% for media in media_items %}
                    <img src="{{ media.file.url }}" alt="{{ media.phase }} photo">
                  {% endfor %}
                {% else %}
                  <img src="https://via.placeholder.com/130x100?text=Before" alt="Before photo">
                  <img src="https://via.placeholder.com/130x100?text=After" alt="After photo">
                  <img src="https://via.placeholder.com/130x100?text=Kitchen" alt="Kitchen photo">
                  <img src="https://via.placeholder.com/130x100?text=Bathroom" alt="Bathroom photo">
                {% endif %}
              </div>
              <button class="arrow-btn right">‚Ä∫</button>
            </div>
<div class="media-pagination">
  <span class="media-dot active"></span>
  <span class="media-dot"></span>
  <span class="media-dot"></span>
</div>
<br>
            <div class="gallery-actions">
              <button class="btn btn-blue" id="approveWorkBtn">Approve Work</button>
           <button class="btn btn-light" id="requestFixBtn">Request Fix</button>
            </div>
            {% if latest_request_fix %}
              <div class="request-fix-status">
                Request Fix Status:
                <span class="status-badge status-{{ latest_request_fix.status|lower }}">
                  {{ latest_request_fix.get_status_display }}
                </span>
                <span class="status-time">
                  ‚Ä¢ {{ latest_request_fix.created_at|date:"M d, Y H:i" }}
                </span>
              </div>
            {% endif %}
          </div>

          <div class="card help">
            <span class="need-help"><img src="{% static 'images/vector27.svg'%}" alt="">Need help?</span>
            <p>Something not right with your service? Let us know.</p>
            <div class="actions">
                <a href="{% url 'accounts:Report_Incident' %}" class="report-btn">
                  <img src="{% static 'images/commercial0.png'%}" alt="Report">
                  Report an Incident
                </a>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  {% if can_rate %}
  <!-- ===== REVIEW POPUP ===== -->
  <div class="popup-overlay" id="reviewPopup">
    <form method="post" class="popup review-popup">
      {% csrf_token %}
      <input type="hidden" name="form_type" value="rating">
      <input type="hidden" name="booking_type" value="{{ booking_type }}">
      <input type="hidden" name="booking_id" value="{{ booking.id }}">

      <button type="button" class="close-btn" onclick="closeReviewPopup()">x</button>
      <h3>Rate Provider</h3>

      {% if rating_form.errors %}
        <div class="form-errors">Please check the ratings and try again.</div>
      {% endif %}

      <div class="review-grid">
        <div>
          <label>Overall</label>
          <div class="star-rating">
            <input type="radio" id="overall-5" name="overall_rating" value="5" required>
            <label for="overall-5">‚òÖ</label>
            <input type="radio" id="overall-4" name="overall_rating" value="4">
            <label for="overall-4">‚òÖ</label>
            <input type="radio" id="overall-3" name="overall_rating" value="3">
            <label for="overall-3">‚òÖ</label>
            <input type="radio" id="overall-2" name="overall_rating" value="2">
            <label for="overall-2">‚òÖ</label>
            <input type="radio" id="overall-1" name="overall_rating" value="1">
            <label for="overall-1">‚òÖ</label>
          </div>
        </div>
        <div>
          <label>Punctuality</label>
          <div class="star-rating">
            <input type="radio" id="punctuality-5" name="punctuality" value="5" required>
            <label for="punctuality-5">‚òÖ</label>
            <input type="radio" id="punctuality-4" name="punctuality" value="4">
            <label for="punctuality-4">‚òÖ</label>
            <input type="radio" id="punctuality-3" name="punctuality" value="3">
            <label for="punctuality-3">‚òÖ</label>
            <input type="radio" id="punctuality-2" name="punctuality" value="2">
            <label for="punctuality-2">‚òÖ</label>
            <input type="radio" id="punctuality-1" name="punctuality" value="1">
            <label for="punctuality-1">‚òÖ</label>
          </div>
        </div>
        <div>
          <label>Quality</label>
          <div class="star-rating">
            <input type="radio" id="quality-5" name="quality" value="5" required>
            <label for="quality-5">‚òÖ</label>
            <input type="radio" id="quality-4" name="quality" value="4">
            <label for="quality-4">‚òÖ</label>
            <input type="radio" id="quality-3" name="quality" value="3">
            <label for="quality-3">‚òÖ</label>
            <input type="radio" id="quality-2" name="quality" value="2">
            <label for="quality-2">‚òÖ</label>
            <input type="radio" id="quality-1" name="quality" value="1">
            <label for="quality-1">‚òÖ</label>
          </div>
        </div>
        <div>
          <label>Professionalism</label>
          <div class="star-rating">
            <input type="radio" id="professionalism-5" name="professionalism" value="5" required>
            <label for="professionalism-5">‚òÖ</label>
            <input type="radio" id="professionalism-4" name="professionalism" value="4">
            <label for="professionalism-4">‚òÖ</label>
            <input type="radio" id="professionalism-3" name="professionalism" value="3">
            <label for="professionalism-3">‚òÖ</label>
            <input type="radio" id="professionalism-2" name="professionalism" value="2">
            <label for="professionalism-2">‚òÖ</label>
            <input type="radio" id="professionalism-1" name="professionalism" value="1">
            <label for="professionalism-1">‚òÖ</label>
          </div>
        </div>
        <div>
          <label>Value</label>
          <div class="star-rating">
            <input type="radio" id="value-5" name="value" value="5" required>
            <label for="value-5">‚òÖ</label>
            <input type="radio" id="value-4" name="value" value="4">
            <label for="value-4">‚òÖ</label>
            <input type="radio" id="value-3" name="value" value="3">
            <label for="value-3">‚òÖ</label>
            <input type="radio" id="value-2" name="value" value="2">
            <label for="value-2">‚òÖ</label>
            <input type="radio" id="value-1" name="value" value="1">
            <label for="value-1">‚òÖ</label>
          </div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <label>Feedback</label>
        <textarea name="feedback" placeholder="Optional note"></textarea>
      </div>

      <div class="review-actions">
        <button type="submit" class="primary">Submit Rating</button>
        <button type="button" class="secondary" onclick="closeReviewPopup()">Cancel</button>
      </div>
    </form>
  </div>
  {% endif %}

    <!-- ===== APPROVE WORK POPUP ===== -->
  <div class="popup-overlay" id="popupOverlay">
    <div class="popup approve-popup">
      <button class="close-btn" id="closePopupBtn">?</button>
      <img class="logo" src="{% static 'images/frame-16865526320.png'%}" alt="Happy Home Logo">
      <p class="message">
        <strong>Happy home, happy you ??</strong><br>
        Clean, fresh, and ready to enjoy. Until next time!
      </p>
      <div class="buttons">
        {% if booking_type == "private" %}
          <a class="primary" href="{% url 'home:all_services_private' %}">Book Again</a>
        {% else %}
          <a class="primary" href="{% url 'home:business_all_services' %}">Book Again</a>
        {% endif %}
        <a class="secondary" href="{% url 'accounts:Payment_and_Billing' %}">View Receipt</a>
        <a class="secondary" href="{% url 'home:home' %}">Home</a>
      </div>
    </div>
  </div>

    <!-- ===== REQUEST FIX POPUP ===== -->
  <div class="popup-overlay" id="fixPopupOverlay">
    <form class="popup request-fix-popup" id="requestFixForm" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="form_type" value="request_fix">
      <button class="close-btn" id="closeFixPopupBtn">?</button>
      <div class="upload-zone" id="requestFixUpload">
        <input type="file" id="requestFixFiles" name="files" accept="image/*" multiple>
        <div class="upload-icon">
          <img src="{% static 'images/frame-16865526200.svg'%}" alt="Upload">
        </div>
        <div class="upload-text">
          <strong>Add photos (optional)</strong>
          <span>PNG, JPG up to 10MB</span>
        </div>
      </div>
      <div class="upload-previews" id="requestFixPreviews"></div>
      <p class="message">
        <strong>Request Fix ??</strong><br>
        Please describe what needs to be corrected. Our team will review it right away!
      </p>
      <textarea name="message" placeholder="Describe your issue..." required></textarea>
      <div class="buttons" style="margin-top:20px;">
        <button class="primary" type="submit">Send Request</button>
        <button class="secondary" type="button" id="cancelFixBtn">Cancel</button>
      </div>
    </form>
  </div>



  <!-- ===== ADD-ONS POPUP ===== -->
  <div class="popup-overlay" id="addonsPopupOverlay">
    <div class="popup addons-popup">
      <button class="close-btn" id="closeAddonsPopup">?</button>
      <h3 class="addons-title">Available Add-ons</h3>
      <div class="addons-body">
        <div id="addonsList"></div>
        <div id="addonFormPane" class="addon-form-pane"></div>
      </div>
      <div class="buttons addons-actions">
        <button class="secondary" type="button" id="cancelAddonsPopup">Cancel</button>
        <button class="primary" type="button" id="saveAddonsPopup">Save Add-ons</button>
      </div>
    </div>
  </div>
{% include "home/includes/footer.html" %}

<div class="page-save" id="pageSave">
  <button type="submit" form="checklistForm" class="save-float-btn">Save</button>
</div>
<script>
const noteBox = document.getElementById("addNoteBox");
const noteInput = document.getElementById("noteInput");
const notesList = document.getElementById("notesList");

const bookingId = document.getElementById("bookingId").value;
const bookingType = document.getElementById("bookingType").value;

function openNoteBox() {
  noteBox.style.display = "block";
  noteInput.focus();
}

function cancelNote() {
  noteInput.value = "";
  noteBox.style.display = "none";
}

function saveNote() {
  const text = noteInput.value.trim();
  if (!text) return;

  fetch("/booking/add-note/", {
    method: "POST",
    headers: {
      "X-CSRFToken": getCookie("csrftoken"),
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: `text=${encodeURIComponent(text)}&booking_id=${bookingId}&booking_type=${bookingType}`
  })
  .then(res => res.json())
  .then(data => {
    const li = document.createElement("li");
    li.innerHTML = `<span class="dot"></span><span>${data.text}</span>`;
    notesList.appendChild(li);

    noteInput.value = "";
    noteBox.style.display = "none";
  });
}

function getCookie(name) {
  let cookieValue = null;
  document.cookie.split(";").forEach(c => {
    c = c.trim();
    if (c.startsWith(name + "=")) {
      cookieValue = decodeURIComponent(c.substring(name.length + 1));
    }
  });
  return cookieValue;
}
</script>
<script>
(function () {
  const saveBar = document.getElementById("pageSave");
  if (!saveBar) return;
  function toggleSaveBar() {
    const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 220;
    saveBar.classList.toggle("show", nearBottom);
  }
  window.addEventListener("scroll", toggleSaveBar);
  toggleSaveBar();
})();
</script>

<script>
(function () {
  const toggle = document.getElementById("menuToggle");
  const sidebar = document.querySelector(".sidebar");
  const overlay = document.querySelector(".customer-menu-overlay");
  if (!toggle || !sidebar) return;
  toggle.addEventListener("click", () => {
    const open = sidebar.classList.toggle("open");
    if (overlay) overlay.classList.toggle("show", open);
  });
  if (overlay) {
    overlay.addEventListener("click", () => {
      sidebar.classList.remove("open");
      overlay.classList.remove("show");
    });
  }
})();
</script>
<script src="{% static 'js/main_header.js' %}"></script>
  <!-- ====== JavaScript ====== -->
  <script>
    // ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ©
    const toggle = document.getElementById("menuToggle");
    const sidebar = document.querySelector(".sidebar");
    const menuOverlay = document.getElementById("menuOverlay");
    const arrow = document.querySelector(".menu-toggle .arrow");

    toggle.addEventListener("click", () => {
      sidebar.classList.toggle("open");
      menuOverlay.classList.toggle("show");
      arrow.innerHTML = sidebar.classList.contains("open") ? "&#8249;" : "&#8250;";
    });

    menuOverlay.addEventListener("click", () => {
      sidebar.classList.remove("open");
      menuOverlay.classList.remove("show");
      arrow.innerHTML = "&#8250;";
    });

    // === APPROVE WORK POPUP ===
    const popupOverlay = document.getElementById("popupOverlay");
    const approveWorkBtn = document.getElementById("approveWorkBtn");
    const closePopupBtn = document.getElementById("closePopupBtn");

    approveWorkBtn.addEventListener("click", () => {
      popupOverlay.classList.add("active");
    });
    closePopupBtn.addEventListener("click", () => {
      popupOverlay.classList.remove("active");
    });
    popupOverlay.addEventListener("click", (e) => {
      if (e.target === popupOverlay) popupOverlay.classList.remove("active");
    });

    // === REQUEST FIX POPUP ===
    const fixPopupOverlay = document.getElementById("fixPopupOverlay");
    const requestFixBtn = document.getElementById("requestFixBtn");
    const closeFixPopupBtn = document.getElementById("closeFixPopupBtn");
    const cancelFixBtn = document.getElementById("cancelFixBtn");

    requestFixBtn.addEventListener("click", () => {
      fixPopupOverlay.classList.add("active");
    });
    closeFixPopupBtn.addEventListener("click", () => {
      fixPopupOverlay.classList.remove("active");
    });
    cancelFixBtn.addEventListener("click", () => {
      fixPopupOverlay.classList.remove("active");
    });
    fixPopupOverlay.addEventListener("click", (e) => {
      if (e.target === fixPopupOverlay) fixPopupOverlay.classList.remove("active");
    });

    const fixUpload = document.getElementById("requestFixUpload");
    const fixFiles = document.getElementById("requestFixFiles");
    const fixPreviews = document.getElementById("requestFixPreviews");

    function clearFixUploads() {
      if (fixFiles) fixFiles.value = "";
      if (fixPreviews) fixPreviews.innerHTML = "";
    }

    if (fixUpload && fixFiles) {
      fixUpload.addEventListener("click", () => {
        fixFiles.click();
      });
    }

    if (fixFiles && fixPreviews) {
      fixFiles.addEventListener("change", () => {
        fixPreviews.innerHTML = "";
        Array.from(fixFiles.files).forEach((file) => {
          if (!file.type.startsWith("image/")) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            const wrap = document.createElement("div");
            wrap.className = "upload-preview";
            const img = document.createElement("img");
            img.src = e.target.result;
            img.alt = file.name;
            wrap.appendChild(img);
            fixPreviews.appendChild(wrap);
          };
          reader.readAsDataURL(file);
        });
      });
    }

    closeFixPopupBtn.addEventListener("click", clearFixUploads);
    cancelFixBtn.addEventListener("click", clearFixUploads);
    fixPopupOverlay.addEventListener("click", (e) => {
      if (e.target === fixPopupOverlay) clearFixUploads();
    });
  </script>
  <script>
const track = document.querySelector('.media-track');
const dots = document.querySelectorAll('.media-dot');
const btnLeft = document.querySelector('.arrow-btn.left');
const btnRight = document.querySelector('.arrow-btn.right');

let currentIndex = 0;
const total = dots.length;

function updateCarousel() {
  const offset = -currentIndex * 140; // ÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ±ÿ© + ÿßŸÑŸÖÿ≥ÿßŸÅÿ©
  track.style.transform = `translateX(${offset}px)`;
  dots.forEach((dot, i) => dot.classList.toggle('active', i === currentIndex));
}

btnRight.addEventListener('click', () => {
  currentIndex = (currentIndex + 1) % total;
  updateCarousel();
});
btnLeft.addEventListener('click', () => {
  currentIndex = (currentIndex - 1 + total) % total;
  updateCarousel();
});
dots.forEach((dot, i) => {
  dot.addEventListener('click', () => {
    currentIndex = i;
    updateCarousel();
  });
});
</script>
<script>
  // ÿßŸÑÿ®Ÿàÿ® ÿ£ÿ® ÿßŸÑÿÆÿßÿµ ÿ®ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ¨ÿØŸàŸÑÿ© ŸÅŸÇÿ∑
  const reschedulePopup = document.getElementById('reschedulePopup');

  // ŸÅÿ™ÿ≠ ÿßŸÑÿ®Ÿàÿ® ÿ£ÿ® ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≤ÿ± Reschedule
  function openPopup() {
    reschedulePopup.classList.add('active');
  }

  // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿ®Ÿàÿ® ÿ£ÿ® ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ √ó ÿ£Ÿà Cancel
  function closePopup() {
    reschedulePopup.classList.remove('active');
  }

  // ŸÉŸÖÿßŸÜ ÿ•ÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ≥ŸàÿØÿß (ÿÆÿßÿ±ÿ¨ ÿßŸÑŸÖÿ±ÿ®ÿπ)ÿå ÿ®Ÿäÿ™ÿ≥ŸÉÿ±
  reschedulePopup.addEventListener('click', (e) => {
    if (e.target === reschedulePopup) {
      closePopup();
    }
  });
</script>
<script>
  const rescheduleSuccessOverlay = document.getElementById('rescheduleSuccessOverlay');
  const rescheduleSuccessPopup = document.getElementById('rescheduleSuccessPopup');

  function showRescheduleSuccess() {
    // ÿ£ÿ∫ŸÑŸÇŸä ÿ®Ÿàÿ® ÿ£ÿ® ÿßŸÑÿ¨ÿØŸàŸÑÿ© ÿ£ŸàŸÑÿßŸã
    closePopup();

    // ÿ®ÿπÿØ ŸÑÿ≠ÿ∏ÿ© ŸÇÿµŸäÿ±ÿ© ÿßŸÅÿ™ÿ≠Ÿä ÿ®Ÿàÿ® ÿ£ÿ® ÿßŸÑŸÜÿ¨ÿßÿ≠
    setTimeout(() => {
      rescheduleSuccessOverlay.classList.add('active');
      rescheduleSuccessPopup.classList.add('active');
    }, 250);
  }

  function closeRescheduleSuccess() {
    rescheduleSuccessOverlay.classList.remove('active');
    rescheduleSuccessPopup.classList.remove('active');
  }

  // ŸÉŸÖÿßŸÜ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑÿÆŸÑŸÅŸäÿ© Ÿäÿ∫ŸÑŸÇ ÿßŸÑÿ®Ÿàÿ® ÿ£ÿ®
  rescheduleSuccessOverlay.addEventListener('click', closeRescheduleSuccess);
</script>

<script>
  const cancelPopup = document.getElementById('cancelPopup');

  function openCancelPopup() {
    cancelPopup.classList.add('active');
  }

  function closeCancelPopup() {
    cancelPopup.classList.remove('active');
  }

  // ÿ≥ŸÉŸëÿ± ÿ•ÿ∞ÿß ŸÉÿ®ÿ≥ ÿ®ÿ±ÿß
  cancelPopup.addEventListener('click', (e) => {
    if (e.target === cancelPopup) {
      closeCancelPopup();
    }
  });
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  if (params.get("cancel") === "1") {
    const popup = document.getElementById("cancelPopup");
    if (popup) {
      popup.classList.add("active");
    }
  }
});
</script>
<script>
function toggleNoteForm() {
  const form = document.getElementById("noteForm");
  form.style.display = form.style.display === "none" ? "block" : "none";
}
</script>

<script>
function openReviewPopup() {
  const popup = document.getElementById("reviewPopup");
  if (popup) {
    popup.classList.add("active");
  }
}

function closeReviewPopup() {
  const popup = document.getElementById("reviewPopup");
  if (popup) {
    popup.classList.remove("active");
  }
}

{% if rating_form.errors %}
document.addEventListener("DOMContentLoaded", () => {
  openReviewPopup();
});
{% endif %}
</script>

<script>
function formatDuration(seconds) {
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = seconds % 60;

  let text = "";
  if (h > 0) text += h + "h ";
  if (m > 0 || h > 0) text += m + "m ";
  text += s + "s";

  return text;
}

const container = document.getElementById("timeData");
const output = document.getElementById("actualTime");

if (container) {
  const start = new Date(container.dataset.start);
  const end = container.dataset.end ? new Date(container.dataset.end) : null;
  const quotedSeconds = parseInt(container.dataset.quoted || "0", 10);

  function updateTime() {
    const now = end ? end : new Date();
    const diff = Math.floor((now - start) / 1000);

    if (diff >= 0) {
      if (!end && quotedSeconds > 0) {
        const remaining = Math.max(quotedSeconds - diff, 0);
        output.innerText = formatDuration(remaining);
      } else {
        output.innerText = formatDuration(diff);
      }
    }
  }

  updateTime();

  if (!end) {
    setInterval(updateTime, 1000);
  }
}
</script>


<script>
const AVAILABLE_ADDONS = {{ available_addons_json|safe }};
const SAVED_ADDONS = {{ saved_addons_json|safe }};
let ADDONS_DATA = SAVED_ADDONS || {};
let CURRENT_SERVICE = null;
let CURRENT_ADDON = null;

const addonsOverlay = document.getElementById("addonsPopupOverlay");
const addonsList = document.getElementById("addonsList");
const addonFormPane = document.getElementById("addonFormPane");
const openAddonsBtn = document.getElementById("openAddonsPopup");
const closeAddonsBtn = document.getElementById("closeAddonsPopup");
const cancelAddonsBtn = document.getElementById("cancelAddonsPopup");
const saveAddonsBtn = document.getElementById("saveAddonsPopup");

function openAddonsPopup() {
  if (!addonsOverlay) return;
  renderAddonsList();
  addonsOverlay.classList.add("active");
}

function closeAddonsPopup() {
  if (!addonsOverlay) return;
  addonsOverlay.classList.remove("active");
  CURRENT_ADDON = null;
  addonFormPane.innerHTML = "";
}

function renderAddonsList() {
  if (!addonsList) return;
  CURRENT_ADDON = null;
  addonFormPane.innerHTML = "";

  let html = "";
  const serviceSlugs = Object.keys(AVAILABLE_ADDONS || {});
  if (!serviceSlugs.length) {
    addonsList.innerHTML = "<p class='addons-empty'>No additional add-ons available.</p>";
    return;
  }

  serviceSlugs.forEach((svc) => {
    const svcData = AVAILABLE_ADDONS[svc];
    const addons = svcData.addons || {};
    const addonKeys = Object.keys(addons);

    let sectionHtml = "";
    addonKeys.forEach((key) => {
      const already = ADDONS_DATA[svc] && ADDONS_DATA[svc][key];
      if (already) return;
      const ad = addons[key];
      sectionHtml += `
        <button type="button" class="addon-card" data-service="${svc}" data-addon="${key}">
          <div class="addon-icon-wrap">
            ${ad.icon ? `<img src="${ad.icon}" alt="">` : `<span class="addon-icon-fallback">+</span>`}
          </div>
          <div class="addon-info">
            <div class="addon-title">${ad.label}</div>
            <div class="addon-price">$${Number(ad.price || 0).toFixed(2)}</div>
          </div>
        </button>
      `;
    });

    if (sectionHtml) {
      html += `<div class="addons-group"><div class="addons-group-title">${svcData.title || svc}</div>`;
      html += `<div class="addons-grid">${sectionHtml}</div></div>`;
    }
  });

  addonsList.innerHTML = html || "<p class='addons-empty'>No additional add-ons available.</p>";
  addonsList.querySelectorAll(".addon-card").forEach((card) => {
    card.addEventListener("click", () => {
      const svc = card.dataset.service;
      const addon = card.dataset.addon;
      openAddonForm(svc, addon);
    });
  });
}

function openAddonForm(serviceSlug, addonKey) {
  CURRENT_SERVICE = serviceSlug;
  CURRENT_ADDON = addonKey;
  const addon = AVAILABLE_ADDONS?.[serviceSlug]?.addons?.[addonKey];
  if (!addon) return;

  addonFormPane.innerHTML = `
    <div class="addon-form-head">${addon.label}</div>
    <div class="addon-form-body">
      ${addon.form || ""}
    </div>
    <button type="button" class="btn-back" id="backToAddons">? Back to list</button>
  `;

  if (window.initCustomSelects) {
    window.initCustomSelects();
  }

  const backBtn = document.getElementById("backToAddons");
  if (backBtn) backBtn.addEventListener("click", renderAddonsList);

  if (ADDONS_DATA[serviceSlug] && ADDONS_DATA[serviceSlug][addonKey]) {
    const saved = ADDONS_DATA[serviceSlug][addonKey];
    const fields = addonFormPane.querySelectorAll("input, textarea, select");
    fields.forEach((f) => {
      if (saved[f.name] !== undefined) {
        if (f.type === "radio" || f.type === "checkbox") {
          if (Array.isArray(saved[f.name])) {
            if (saved[f.name].includes(f.value)) f.checked = true;
          } else if (saved[f.name] === f.value) {
            f.checked = true;
          }
        } else {
          f.value = saved[f.name];
        }
      }
    });
  }
}

function collectAddonFormData() {
  const fields = addonFormPane.querySelectorAll("input, textarea, select");
  let data = {};
  let valid = true;
  let radioGroups = {};

  fields.forEach((f) => {
    if (!f.name) return;

    if (f.type === "radio") {
      radioGroups[f.name] = radioGroups[f.name] || { any: false };
      if (f.checked) {
        radioGroups[f.name].any = true;
        data[f.name] = f.value;
      }
    } else if (f.type === "checkbox") {
      radioGroups[f.name] = radioGroups[f.name] || { any: false };
      if (f.checked) {
        radioGroups[f.name].any = true;
        data[f.name] = data[f.name] || [];
        data[f.name].push(f.value);
      }
    } else {
      const v = (f.value || "").trim();
      data[f.name] = v;
      if (!v) valid = false;
    }
  });

  for (let g in radioGroups) {
    if (!radioGroups[g].any) valid = false;
  }

  return { data, valid };
}

function updateCharges(pricing) {
  if (!pricing) return;
  const rows = document.querySelector(".card.charges .rows");
  let subtotalEl = document.getElementById("chargeSubtotal");
  let discountEl = document.getElementById("chargeDiscount");
  let totalEl = document.getElementById("chargeTotal");
  const totalBottomEl = document.getElementById("chargeTotalBottom");

  if (!subtotalEl && rows) {
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `<span>Subtotal</span><span id="chargeSubtotal"></span>`;
    rows.insertBefore(row, rows.firstChild);
    subtotalEl = row.querySelector("#chargeSubtotal");
  }

  if (!discountEl && rows) {
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `<span>Discount</span><span class="green" id="chargeDiscount"></span>`;
    const totalRow = rows.querySelector("#chargeTotal")?.parentElement || null;
    if (totalRow) {
      rows.insertBefore(row, totalRow);
    } else {
      rows.appendChild(row);
    }
    discountEl = row.querySelector("#chargeDiscount");
  }

  if (subtotalEl) subtotalEl.textContent = `$${Number(pricing.subtotal || 0).toFixed(2)}`;
  if (discountEl) discountEl.textContent = `-$${Number(pricing.rot || 0).toFixed(2)}`;
  if (totalEl) totalEl.textContent = `$${Number(pricing.final || 0).toFixed(2)}`;
  if (totalBottomEl) totalBottomEl.textContent = `$${Number(pricing.final || 0).toFixed(2)}`;
}

function sendAddonsUpdate() {
  const fd = new FormData();
  fd.append("addons_json", JSON.stringify(ADDONS_DATA));
  fetch(`/private/api/booking/{{ booking.id }}/update-addons/`, {
    method: "POST",
    body: fd,
  })
    .then((r) => r.json())
    .then((data) => {
      if (data && data.pricing) updateCharges(data.pricing);
    });
}

if (openAddonsBtn) {
  openAddonsBtn.addEventListener("click", openAddonsPopup);
}
if (closeAddonsBtn) closeAddonsBtn.addEventListener("click", closeAddonsPopup);
if (cancelAddonsBtn) cancelAddonsBtn.addEventListener("click", closeAddonsPopup);
if (addonsOverlay) {
  addonsOverlay.addEventListener("click", (e) => {
    if (e.target === addonsOverlay) closeAddonsPopup();
  });
}

if (saveAddonsBtn) {
  saveAddonsBtn.addEventListener("click", () => {
    if (!CURRENT_ADDON) {
      closeAddonsPopup();
      return;
    }

    const { data, valid } = collectAddonFormData();
    if (!valid) {
      alert("Please answer all questions for this add-on before saving.");
      return;
    }

    ADDONS_DATA[CURRENT_SERVICE] = ADDONS_DATA[CURRENT_SERVICE] || {};
    ADDONS_DATA[CURRENT_SERVICE][CURRENT_ADDON] = data;
    sendAddonsUpdate();
    renderAddonsList();
  });
}
</script>
</body>
</html>
