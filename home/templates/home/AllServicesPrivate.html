{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hembla - All Services</title>
  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <link rel="stylesheet" href="{% static 'css/main_header.css' %}">
  <link rel="stylesheet" href="{% static 'css/AllServicesPrivate.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&family=Vesper+Libre:wght@400;700&display=swap" rel="stylesheet">
</head>
{% include "home/includes/main_header.html" %}

<body>

<main class="services-section">

    <div class="section-header">
      <div>
        <h1>All Services</h1>
        <p class="section-subtitle">Search by name, description, or focus on recommended services.</p>
      </div>
      <div class="header-actions">
        <a href="{% url 'home:private_cart' %}" class="cart-box" aria-label="View cart">
          <span class="cart-icon">ðŸ›’</span>
          <span id="cart-count">0</span>
        </a>
      </div>
    </div>

    <div class="filter-bar">
      <div class="search-field">
        <input type="text" id="serviceSearch" placeholder="Search by name or description">
      </div>
      <div class="filter-pills">
        <button type="button" class="filter-pill active" data-filter="all">All</button>
        <button type="button" class="filter-pill" data-filter="recommended">Recommended</button>
        <button type="button" class="filter-pill" data-filter="clear" id="clearFilters">Clear</button>
      </div>
      <div class="results-count" id="resultsCount">0 services</div>
    </div>

    <hr />

    <div class="services-list" id="servicesList">

      {% for service in services %}
      <div class="service-card fade-in"
           data-title="{{ service.title|lower|escape }}"
           data-description="{{ service.description|lower|escape }}"
           data-recommended="{% if service.recommended %}true{% else %}false{% endif %}">

        {% if service.image %}
          <img src="{{ service.image.url }}" alt="{{ service.title }}">
        {% else %}
          <div class="service-image placeholder">{{ service.title|first }}</div>
        {% endif %}

        <div class="service-info">
          <div class="title-row">
            <h2>
              <a class="service-title-link" href="{% url 'accounts:service_detail' service.slug %}">
                {{ service.title }}
              </a>
            </h2>
            {% if service.recommended %}
              <span class="rec-badge">Recommended</span>
            {% endif %}
          </div>
          <p>{{ service.description }}</p>

          {% if service.recommended %}
            <span class="rec-note">{{ service.recommended }}</span>
          {% endif %}
        </div>

        <div class="service-actions">
          <button class="btn-cart" onclick="addToCart('{{ service.slug }}')">Add to Cart</button>
          <a href="{% url 'home:private_zip_step1' service.slug %}" class="btn-book">Book Now</a>
        </div>

      </div>
      {% endfor %}

    </div>
</main> 

<script>
function addToCart(slug) {
    fetch(`/private/cart/add/${slug}/`)
        .then(r => r.json())
        .then(data => {
            if (data.count !== undefined) {
                document.getElementById("cart-count").innerText = data.count;
            }
        });
}

function refreshCartCount() {
    fetch("/private/cart/count/")
        .then(r => r.json())
        .then(data => {
            if (data.count !== undefined) {
                document.getElementById("cart-count").innerText = data.count;
            }
        })
        .catch(err => console.log("Cart Refresh Error:", err));
}

setInterval(refreshCartCount, 2000);

const searchInput = document.getElementById("serviceSearch");
const resultsCount = document.getElementById("resultsCount");
const filterPills = document.querySelectorAll(".filter-pill");
const cards = Array.from(document.querySelectorAll(".service-card"));

function applyFilters() {
    const query = (searchInput?.value || "").trim().toLowerCase();
    const activePill = document.querySelector(".filter-pill.active");
    const activeFilter = activePill ? activePill.dataset.filter : "all";

    let visibleCount = 0;

    cards.forEach(card => {
        const title = card.dataset.title || "";
        const desc = card.dataset.description || "";
        const isRecommended = card.dataset.recommended === "true";

        const matchesQuery = !query || title.includes(query) || desc.includes(query);
        const matchesRecommended = activeFilter !== "recommended" || isRecommended;

        const shouldShow = matchesQuery && matchesRecommended;
        card.style.display = shouldShow ? "" : "none";
        if (shouldShow) visibleCount += 1;
    });

    if (resultsCount) {
        resultsCount.textContent = `${visibleCount} service${visibleCount === 1 ? "" : "s"}`;
    }
}

filterPills.forEach(pill => {
    pill.addEventListener("click", () => {
        if (pill.dataset.filter === "clear") {
            filterPills.forEach(p => p.classList.remove("active"));
            document.querySelector('[data-filter="all"]')?.classList.add("active");
            if (searchInput) searchInput.value = "";
        } else {
            filterPills.forEach(p => p.classList.remove("active"));
            pill.classList.add("active");
        }
        applyFilters();
    });
});

searchInput?.addEventListener("input", () => applyFilters());
document.addEventListener("DOMContentLoaded", applyFilters);
</script>
</body>
</html>
