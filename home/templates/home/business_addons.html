{% load static %}
{% load bootstrap4 %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add-Ons</title>
  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <link rel="stylesheet" href="{% static 'css/main_header.css' %}">
  <link rel="stylesheet" href="{% static 'css/business_addons.css' %}">
  <link rel="stylesheet" href="{% static 'css/business_steps.css' %}">
</head>

<body>
  {% include "home/includes/main_header.html" %}

  <main class="container">
    <div class="steps">
      {% for i in range_total_steps %}
        <div class="step {% if step == i %}active{% endif %}">
          Step {{ i }}
        </div>
      {% endfor %}
    </div>

    <section class="section-title">
      <h2><span class="title-icon" aria-hidden="true">&#10133;</span> Add-Ons</h2>
      <p>Think of add-ons as the extras that businesses often forget, but really need.</p>
    </section>

    <form method="POST" id="addonsForm" data-skip-validate>
      {% csrf_token %}
      <input type="hidden" name="selected_addons" id="selectedAddonsInput">

      <section class="addons-grid">
        {% for a in addons %}
          <div class="addon-card" data-id="{{ a.id }}" data-title="{{ a.title }}">
            <div class="checkmark-box"></div>
            <div class="addon-content">
              <h3><span class="addon-emoji">{{ a.emoji }}</span>{{ a.title }}</h3>
              <p>{{ a.description }}</p>
            </div>
          </div>
        {% endfor %}

        <div class="addon-card other-card" data-id="other" data-title="Other">
          <div class="checkmark-box"></div>
          <div class="addon-content">
            <h3><span class="addon-emoji">&#9998;</span>Other</h3>
            <p>(eco-products only, extra fridge cleaning, locker room service...)</p>
            <textarea id="otherInput" class="other-text" placeholder="Write your custom add-on here..."></textarea>
          </div>
        </div>
      </section>

      <div class="confirm-btn">
        <a onclick="window.history.back();" class="back-btn">
          <span class="back-icon">&larr;</span>
          Back
        </a>
        <button type="submit" class="next-btn">
          Confirm Add-ons
          <span class="next-icon">&rarr;</span>
        </button>
      </div>
    </form>
  </main>

  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>

  {% include "home/includes/footer.html" %}

  <script>
    let selected = [];
    const cards = document.querySelectorAll(".addon-card");
    const otherInput = document.getElementById("otherInput");

    const syncSelected = () => {
      document.getElementById("selectedAddonsInput").value = JSON.stringify(selected);
    };

    cards.forEach((card) => {
      card.addEventListener("click", () => {
        const id = card.dataset.id;
        const title = card.dataset.title;

        card.classList.toggle("selected");

        if (card.classList.contains("selected")) {
          if (id === "other") {
            selected.push({
              id: "other",
              title: "Other",
              value: otherInput.value
            });
          } else {
            selected.push({
              id: id,
              title: title
            });
          }
        } else {
          selected = selected.filter((x) => x.id !== id);
        }

        syncSelected();
      });
    });

    if (otherInput) {
      otherInput.addEventListener("input", () => {
        const otherCard = document.querySelector('.addon-card[data-id="other"]');
        if (!otherCard.classList.contains("selected")) {
          otherCard.classList.add("selected");
          selected = selected.filter((x) => x.id !== "other");
          selected.push({
            id: "other",
            title: "Other",
            value: otherInput.value
          });
        } else {
          const found = selected.find((x) => x.id === "other");
          if (found) {
            found.value = otherInput.value;
          }
        }
        syncSelected();
      });
    }
  </script>

  <script src="{% static 'js/main_header.js' %}"></script>
</body>
</html>
