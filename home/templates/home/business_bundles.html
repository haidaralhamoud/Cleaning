{% load static %}
{% load bootstrap4 %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Service Bundles</title>
  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <link rel="stylesheet" href="{% static 'css/main_header.css' %}">
  <link rel="stylesheet" href="{% static 'css/business_bundles.css' %}">
  <link rel="stylesheet" href="{% static 'css/business_steps.css' %}">
</head>

<body>
  {% include "home/includes/main_header.html" %}

  <div class="steps">
    {% for i in range_total_steps %}
      <div class="step {% if step == i %}active{% endif %}">
        Step {{ i }}
      </div>
    {% endfor %}
  </div>

  <section class="page-head">
    <div class="container">
      <h1 class="page-title">Service Bundles</h1>
    </div>
  </section>

  <main class="container">
    <div class="grid">
      {% for b in bundles %}
        <article class="bundle">
          <div class="bundle__media">
            {% if b.image %}
              <img src="{{ b.image.url }}" alt="{{ b.title }}">
            {% endif %}

            {% if b.discount %}
              <span class="badge">Save {{ b.discount }}</span>
            {% endif %}
          </div>

          <div class="bundle__body">
            <h3 class="bundle__title">{{ b.title }}</h3>
            <p class="bundle__lead">{{ b.short_description }}</p>

            <ul class="bundle__list">
              {% for item in b.features %}
                <li>{{ item }}</li>
              {% endfor %}
            </ul>

            <div class="bundle__actions">
              <button
                type="button"
                class="btn btn-ghost learn-more-btn"
                data-id="{{ b.id }}"
                data-title="{{ b.title }}"
                data-description="{{ b.short_description }}"
                data-target="{{ b.target_audience }}"
                data-included="{{ b.what_included|join:'||' }}"
                data-why="{{ b.why_choose|join:'||' }}"
                data-addons="{{ b.addons|join:'||' }}"
                data-notes="{{ b.notes }}"
                data-discount="{{ b.discount }}"
              >
                Learn More
              </button>

              <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="bundle_id" value="{{ b.id }}">
                <button type="submit" class="btn btn-primary choose-plan" data-type="bundle">
                  Add to booking
                </button>
              </form>
            </div>
          </div>
        </article>
      {% endfor %}

      <article class="bundle bundle--custom">
        <div class="bundle__media bundle__media--custom">
          <div class="plus">+</div>
        </div>
        <div class="bundle__body">
          <h3 class="bundle__title">Custom Plan</h3>
          <p class="bundle__lead">
            Want something unique?<br>
            Tell us what combination works best for your office.
          </p>
          <div class="bundle__actions bundle__actions--single">
            <a href="{% url 'home:business_services_needed' booking_id %}?path=custom"
             class="btn btn-primary btn-wide">
              Create Your Plan
            </a>
          </div>
        </div>
      </article>
    </div>

    <br>
    <div>
      <a onclick="window.history.back();" class="back-btn">
        <span class="back-icon">&larr;</span>
        Back
      </a>
    </div>
  </main>

  <br>
  <br>
  <br>
  <br>

  {% include "home/includes/footer.html" %}

  <form id="modalBundleForm" method="POST" style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="bundle_id" id="modal_bundle_id">
  </form>

  <div id="bundleModal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <div id="modal-body"></div>
    </div>
  </div>

  <script>
    document.querySelectorAll(".learn-more-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const bundleId = btn.dataset.id;
        const title = btn.dataset.title;
        const desc = btn.dataset.description;
        const target = btn.dataset.target;
        const included = btn.dataset.included.split("||");
        const why = btn.dataset.why.split("||");
        const addons = btn.dataset.addons.split("||");
        const notes = btn.dataset.notes;
        const discount = btn.dataset.discount || "10%";

        document.getElementById("modal_bundle_id").value = bundleId;

        const html = `
          <h2><strong>${title}</strong></h2>
          <p>${desc}</p>
          <p><strong>${target}</strong></p>

          <div class="modal-grid">
            <div class="modal-box-section">
              <h3>What's included</h3>
              <ul class="modal-list">
                ${included
                  .map((i) => `<li class="check-item"><span class="check-dot"></span>${i}</li>`)
                  .join("")}
              </ul>
            </div>

            <div class="modal-box-section">
              <h3>Why choose this bundle</h3>
              <ul class="modal-list">
                ${why
                  .map((i) => `<li class="check-item"><span class="check-dot"></span>${i}</li>`)
                  .join("")}
              </ul>
            </div>
          </div>

          <div class="modal-bottom-grid">
            <div class="modal-box-section">
              <h3>Popular add-ons</h3>
              <p>${addons.join(", ")}</p>
            </div>

            <div class="modal-box-section">
              <h3>Notes</h3>
              <p>${notes}</p>
            </div>
          </div>

          <button class="modal-action-btn" id="modalAddBtn">
            Add Bundle and save ${discount}
          </button>
        `;

        document.getElementById("modal-body").innerHTML = html;
        document.getElementById("bundleModal").style.display = "block";

        document.getElementById("modalAddBtn").onclick = () => {
          document.getElementById("modalBundleForm").submit();
        };
      });
    });

    document.querySelector(".close-btn").onclick = () => {
      document.getElementById("bundleModal").style.display = "none";
    };

    window.onclick = (e) => {
      if (e.target.id === "bundleModal") {
        document.getElementById("bundleModal").style.display = "none";
      }
    };
  </script>

  <script>
    let choice = null;

    const buttons = document.querySelectorAll(".choose-plan");

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const type = btn.dataset.type;

        if (choice === type) {
          choice = null;
          resetAll();
          return;
        }

        choice = type;
        resetAll();
        highlight(btn);
      });
    });

    function resetAll() {
      buttons.forEach((b) => {
        b.classList.remove("selected-plan");
        b.classList.remove("disabled-plan");
      });
    }

    function highlight(activeBtn) {
      activeBtn.classList.add("selected-plan");

      buttons.forEach((b) => {
        if (b !== activeBtn) {
          b.classList.add("disabled-plan");
        }
      });
    }
  </script>

  <script src="{% static 'js/main_header.js' %}"></script>
</body>
</html>
