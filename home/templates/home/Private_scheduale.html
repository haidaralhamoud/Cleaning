{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Booking Schedule</title>

<link rel="stylesheet" href="{% static 'css/base.css' %}">
<link rel="stylesheet" href="{% static 'css/main_header.css' %}">
<link rel="stylesheet" href="{% static 'css/Private_scheduale.css' %}">
</head>
<body>
{% include "home/includes/main_header.html" %}

<form method="post" id="scheduleForm" data-skip-validate action="{% url 'home:private_booking_schedule' booking.id %}">
  {% csrf_token %}

  <input type="hidden" name="appointment_date" id="appointment_date">
  <input type="hidden" name="appointment_time_window" id="appointment_time_window">
  <input type="hidden" name="day_work_best" id="day_work_best">
  <input type="hidden" name="End_Date" id="End_Date">
  <input type="hidden" name="frequency_type" id="frequency_type">
  <input type="hidden" name="special_timing_requests" id="special_timing_requests">
  <input type="hidden" name="schedule_mode" id="schedule_mode" value="">
  <input type="hidden" name="schedules_json" id="schedules_json">

  <div class="container">
    <div class="left">
      <div class="step-title">Step 3 of 4</div>
      <div class="progress"></div>

      <h2>When would you like your services</h2>

      {% if services|length > 1 %}
        <p class="mode-caption">How would you like to schedule your services</p>

        <div class="mode-row">
            <div class="mode-card" data-mode="same">
              <div class="mode-title">Use the same schedule for all services</div>
              <small>We will apply this date, time window and frequency to every service in your cart.</small>
              <span class="badge">Fast and easy</span>
            </div>
            <div class="mode-card" data-mode="per_service">
              <div class="mode-title">Set a separate schedule for each service</div>
              <small>Customize date and timing individually for each service.</small>
              <span class="badge">More control</span>
            </div>
        </div>
      {% else %}
        <input type="hidden" id="schedule_mode" name="schedule_mode" value="same">
      {% endif %}

      <div id="sameScheduleArea" class="hidden">
        <p class="section-caption">Schedule for all services:</p>

        <div class="q-row">
          <div class="q-col">
            <div class="calendar-container">
              <div class="calendar-header">
                <div class="month-nav" id="prevMonth">&#10094;</div>
                <div class="month-title" id="monthTitle">Month</div>
                <div class="month-nav" id="nextMonth">&#10095;</div>
              </div>
              <div class="days-of-week">
                <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
              </div>
              <div class="days-grid" id="calendarDays"></div>
            </div>
          </div>

          <div class="q-col">
            <div class="time-box">
              <h3>Q2. Choose a Time Window</h3>
              <div class="time-option" data-time="Morning (08:00 - 12:00)">Morning (08:00 - 12:00)</div>
              <div class="time-option" data-time="Midday (12:00 - 16:00)">Midday (12:00 - 16:00)</div>
              <div class="time-option" data-time="Afternoon (16:00 - 20:00)">Afternoon (16:00 - 20:00)</div>
              <div class="time-option" data-time="Evening (20:00 - 22:00)">Evening (20:00 - 22:00)</div>
            </div>
          </div>
        </div>

        <div class="request-box">
          <h3>Q3. Special Timing Requests (optional)</h3>
          <textarea id="specialRequest" placeholder="Tell us if there is anything we should know..."></textarea>
        </div>

        <h2>Schedule and Frequency</h2>
        <div class="freq-row">
          <div class="freq-col">
            <h3>Q1. How often would you like this service</h3>
            <div class="freq-btn" data-freq="weekly">Weekly <span class="save-tag"></span></div>
            <div class="freq-btn" data-freq="biweekly">Every 2 weeks <span class="save-tag"></span></div>
            <div class="freq-btn" data-freq="monthly">Monthly <span class="save-tag"></span></div>
          </div>

          <div class="freq-col">
            <h3>Q2. Which day(s) work best for you</h3>
            <div class="days-grid2" id="weekDays">
              <label class="day-check weekend"><input type="checkbox" data-day="Mon"/> Monday</label>
              <label class="day-check"><input type="checkbox" data-day="Tue"/> Tuesday</label>
              <label class="day-check"><input type="checkbox" data-day="Wed"/> Wednesday</label>
              <label class="day-check"><input type="checkbox" data-day="Thu"/> Thursday</label>
              <label class="day-check weekend"><input type="checkbox" data-day="Fri"/> Friday</label>
              <label class="day-check weekend"><input type="checkbox" data-day="Sat"/> Saturday</label>
              <label class="day-check weekend"><input type="checkbox" data-day="Sun"/> Sunday</label>
            </div>
          </div>
        </div>

        <div class="end-date">
          <h3>Q3. End Date (optional)</h3>
          <div class="end-date-buttons">
            <div class="end-btn" id="noBtn">No, ongoing until further notice</div>
            <div class="end-btn" id="yesBtn">Yes</div>
          </div>
          <input type="date" id="endDate" class="hidden">
        </div>
      </div>

      <div id="perServiceArea" class="per-service-area hidden">
        <h3 class="section-subtitle">Set a dedicated schedule for each service</h3>

        {% for s in services %}
        <div class="service-acc" data-service="{{ s.slug }}">
          <div class="acc-header">
            <div class="acc-main-info">
              {% if s.image %}
              <img src="{{ s.image.url }}" alt="{{ s.title }}">
              {% endif %}
              <div>
                <div class="acc-name">{{ s.title }}</div>
                <div class="acc-cat">{{ s.category.name }}</div>
              </div>
            </div>
            <button type="button" class="acc-toggle-btn">
              <span>Schedule</span>
              <span class="acc-arrow">v</span>
            </button>
          </div>
          <div class="acc-body">
            <div class="acc-inner">
              <div class="svc-row">
                <div class="svc-col">
                  <label class="svc-label">Date</label>
                  <input type="date" class="svc-input svc-date">
                </div>
                <div class="svc-col">
                  <label class="svc-label">Time Window</label>
                  <select class="svc-select svc-time">
                    <option value="">Select</option>
                    <option value="Morning (08:00 - 12:00)">Morning (08:00 - 12:00)</option>
                    <option value="Midday (12:00 - 16:00)">Midday (12:00 - 16:00)</option>
                    <option value="Afternoon (16:00 - 20:00)">Afternoon (16:00 - 20:00)</option>
                    <option value="Evening (20:00 - 22:00)">Evening (20:00 - 22:00)</option>
                  </select>
                </div>
              </div>

              <div class="svc-row">
                <div class="svc-col">
                  <label class="svc-label">Frequency</label>
                  <select class="svc-select svc-frequency">
                    <option value="">One time only</option>
                    <option value="weekly">Weekly</option>
                    <option value="biweekly">Every 2 weeks</option>
                    <option value="monthly">Monthly</option>
                    <option value="seasonal">Seasonal</option>
                  </select>
                </div>
              </div>

              <div class="svc-row">
                <div class="svc-col">
                  <label class="svc-label">Preferred days</label>
                  <div class="svc-days">
                    <label class="svc-day-pill"><input type="checkbox" class="svc-day" value="Mon"> Mon</label>
                    <label class="svc-day-pill"><input type="checkbox" class="svc-day" value="Tue"> Tue</label>
                    <label class="svc-day-pill"><input type="checkbox" class="svc-day" value="Wed"> Wed</label>
                    <label class="svc-day-pill"><input type="checkbox" class="svc-day" value="Thu"> Thu</label>
                    <label class="svc-day-pill"><input type="checkbox" class="svc-day" value="Fri"> Fri</label>
                    <label class="svc-day-pill"><input type="checkbox" class="svc-day" value="Sat"> Sat</label>
                    <label class="svc-day-pill"><input type="checkbox" class="svc-day" value="Sun"> Sun</label>
                  </div>
                </div>
              </div>

              <div class="svc-row">
                <div class="svc-col">
                  <label class="svc-label">End Date (optional)</label>
                  <div class="svc-end-row">
                    <span class="muted-note">Leave empty for ongoing booking.</span>
                    <input type="date" class="svc-input svc-end-date">
                  </div>
                </div>
              </div>

              <div class="svc-row">
                <div class="svc-col">
                  <label class="svc-label">Special Timing Requests (optional)</label>
                  <textarea class="svc-textarea svc-notes" placeholder="Anything we should know for this service"></textarea>
                </div>
              </div>

            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="primary-action">
        <button type="submit" class="checkout-btn checkout-primary">
          Continue ->
        </button>
      </div>
    </div>

    <div class="right">
        <h3>Booking Summary</h3>
        <div class="line"></div>

        <div class="summary-item">
            <span>Services</span>
            <span id="sum_services">$0</span>
        </div>

        <div class="summary-item">
            <span>Add-ons</span>
            <span id="sum_addons">$0</span>
        </div>

        <div class="summary-item">
            <span>Schedule</span>
            <span id="sum_schedule">$0</span>
        </div>

        <div class="summary-item">
            <span>ROT Deduction</span>
            <span id="sum_rot">$0</span>
        </div>

        <div class="line"></div>

        <div class="summary-item total">
            <span>Total</span>
            <span id="sum_total">$0</span>
        </div>

        <div class="checkout-wrapper">
            <button type="submit" class="checkout-btn">Continue -></button>
        </div>
    </div>
  </div>
</form>

{{ date_rules|json_script:"dateRules" }}
{{ schedule_rules|json_script:"scheduleRules" }}
<script>
let DATE_RULES = JSON.parse(document.getElementById("dateRules").textContent);
if (typeof DATE_RULES === "string") {
  try { DATE_RULES = JSON.parse(DATE_RULES); } catch (err) { DATE_RULES = []; }
}
if (!Array.isArray(DATE_RULES)) { DATE_RULES = []; }

let SCHEDULE_RULES = JSON.parse(document.getElementById("scheduleRules").textContent);
if (typeof SCHEDULE_RULES === "string") {
  try { SCHEDULE_RULES = JSON.parse(SCHEDULE_RULES); } catch (err) { SCHEDULE_RULES = []; }
}
if (!Array.isArray(SCHEDULE_RULES)) { SCHEDULE_RULES = []; }

const frequencyRuleMap = new Map();
const dayRuleMap = new Map();
SCHEDULE_RULES.forEach((rule) => {
  if (!rule) return;
  if (rule.key === "frequency_type" && rule.value) {
    frequencyRuleMap.set(rule.value, Number(rule.price_change));
  }
  if (rule.key === "day" && rule.value) {
    dayRuleMap.set(rule.value, Number(rule.price_change));
  }
});

function updateFrequencyLabels() {
  document.querySelectorAll(".freq-btn").forEach((btn) => {
    const freq = btn.getAttribute("data-freq");
    const tag = btn.querySelector(".save-tag");
    if (!tag) return;
    const amount = frequencyRuleMap.get(freq);
    if (amount === undefined || Number.isNaN(amount)) {
      tag.textContent = "";
      return;
    }
    const absVal = Math.abs(amount);
    tag.textContent = amount < 0 ? `(save up to ${absVal}%)` : `(+${absVal}%)`;
  });
}

function updateDayLabels() {
  const checks = document.querySelectorAll(".day-check input[data-day]");
  checks.forEach((input) => {
    const code = input.getAttribute("data-day");
    const amount = dayRuleMap.get(code);
    const wrapper = input.closest(".day-check");
    if (!wrapper) return;
    let tag = wrapper.querySelector(".weekend-tag");
    if (amount === undefined || Number.isNaN(amount)) {
      if (tag) tag.remove();
      return;
    }
    if (!tag) {
      tag = document.createElement("span");
      tag.className = "weekend-tag";
      wrapper.appendChild(tag);
    }
    const absVal = Math.abs(amount);
    tag.textContent = amount < 0 ? `-${absVal}%` : `+${absVal}%`;
  });
}

function pad(n){ return n < 10 ? "0" + n : n; }
function toDateKey(dateObj){
  const y = dateObj.getFullYear();
  const m = pad(dateObj.getMonth() + 1);
  const d = pad(dateObj.getDate());
  return `${y}-${m}-${d}`;
}
function ruleAmount(rule){
  const amount = Number(rule.amount || 0);
  if (Number.isNaN(amount)) return 0;
  return amount;
}
function formatSurcharge(rule){
  const amount = ruleAmount(rule);
  if (!amount) return "";
  if (rule.surcharge_type === "fixed") {
    return `+$${amount.toFixed(2)}`;
  }
  return `+${amount}%`;
}

const WEEKDAY_CODES = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
const weekdayRules = new Map();
const dateRules = new Map();
DATE_RULES.forEach((rule) => {
  if (!rule) return;
  if (rule.rule_type === "weekday" && rule.weekday) {
    weekdayRules.set(rule.weekday, rule);
  }
  if (rule.rule_type === "date" && rule.date) {
    const key = String(rule.date).slice(0, 10);
    dateRules.set(key, rule);
  }
});

function getRuleForDate(dateObj){
  const key = toDateKey(dateObj);
  if (dateRules.has(key)) return dateRules.get(key);
  const weekday = WEEKDAY_CODES[dateObj.getDay()];
  return weekdayRules.get(weekday) || null;
}

const inputDate    = document.getElementById("appointment_date");
const inputWindow  = document.getElementById("appointment_time_window");
const inputFreq    = document.getElementById("frequency_type");
const inputSpecial = document.getElementById("special_timing_requests");
const inputMode    = document.getElementById("schedule_mode");
const inputSchedulesJson = document.getElementById("schedules_json");

const sameArea       = document.getElementById("sameScheduleArea");
const perServiceArea = document.getElementById("perServiceArea");

const monthNames = ["January","February","March","April","May","June",
                    "July","August","September","October","November","December"];
let currentMonth = new Date().getMonth();
let currentYear  = new Date().getFullYear();

const monthTitle   = document.getElementById("monthTitle");
const calendarDays = document.getElementById("calendarDays");

const modeCards = document.querySelectorAll(".mode-card");
const serviceCount = {{ services|length|default:0 }};
if (serviceCount === 1) {
  inputMode.value = "same";
  if (sameArea) sameArea.style.display = "block";
  if (perServiceArea) perServiceArea.style.display = "none";
}

modeCards.forEach(card => {
  card.addEventListener("click", () => {
    modeCards.forEach(c => c.classList.remove("selected"));
    card.classList.add("selected");
    const mode = card.getAttribute("data-mode");
    inputMode.value = mode;

    if (mode === "same"){
      if (sameArea) sameArea.style.display = "block";
      if (perServiceArea) perServiceArea.style.display = "none";
    } else {
      if (sameArea) sameArea.style.display = "none";
      if (perServiceArea) perServiceArea.style.display = "block";
    }

    updateScheduleSummary();
  });
});

updateFrequencyLabels();
updateDayLabels();

function renderCalendar(month, year){
  if (!calendarDays || !monthTitle) return;

  monthTitle.textContent = `${monthNames[month]} ${year}`;
  calendarDays.innerHTML = "";

  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();

  for (let i = 0; i < firstDay; i++) {
    calendarDays.appendChild(document.createElement("div"));
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const cell = document.createElement("div");
    cell.className = "day";
    cell.textContent = d;

    const jsDate = new Date(year, month, d);
    const weekday = jsDate.getDay();

    const rule = getRuleForDate(jsDate);
    const surchargeLabel = rule ? formatSurcharge(rule) : "";
    if (surchargeLabel) {
      const badge = document.createElement("div");
      badge.className = "day-surcharge";
      badge.textContent = surchargeLabel;
      cell.appendChild(badge);
      cell.classList.add("weekend");
    }

    cell.addEventListener("click", () => {
      document.querySelectorAll(".day").forEach(el => el.classList.remove("selected"));
      cell.classList.add("selected");

      const dateStr = `${year}-${pad(month+1)}-${pad(d)}`;
      inputDate.value = dateStr;

      const weekdayCode = WEEKDAY_CODES[weekday];
      document.getElementById("day_work_best").value = JSON.stringify([weekdayCode]);

      updateScheduleSummary();
    });

    calendarDays.appendChild(cell);
  }
}

renderCalendar(currentMonth, currentYear);

const prevMonthBtn = document.getElementById("prevMonth");
const nextMonthBtn = document.getElementById("nextMonth");
if (prevMonthBtn && nextMonthBtn){
  prevMonthBtn.onclick = () => {
    currentMonth--;
    if (currentMonth < 0) { currentMonth = 11; currentYear--; }
    renderCalendar(currentMonth, currentYear);
  };
  nextMonthBtn.onclick = () => {
    currentMonth++;
    if (currentMonth > 11) { currentMonth = 0; currentYear++; }
    renderCalendar(currentMonth, currentYear);
  };
}

document.querySelectorAll(".time-option").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".time-option").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    if (inputWindow) inputWindow.value = btn.getAttribute("data-time") || "";
    updateScheduleSummary();
  });
});

document.querySelectorAll(".freq-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".freq-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");

    const freqVal = btn.getAttribute("data-freq") || "";
    if (inputFreq) inputFreq.value = freqVal;

    updateScheduleSummary();
  });
});

document.querySelectorAll(".day-check input").forEach(chk=>{
  chk.addEventListener("change",()=>{
    const label = chk.closest(".day-check");
    if (label){
      if (chk.checked) label.classList.add("active");
      else label.classList.remove("active");
    }
    updateScheduleSummary();
  });
});

const yesBtn = document.getElementById("yesBtn");
const noBtn  = document.getElementById("noBtn");
const endDate= document.getElementById("endDate");

if (noBtn && yesBtn && endDate){
  noBtn.classList.add("active");

  yesBtn.onclick = ()=>{
    yesBtn.classList.add("active");
    noBtn.classList.remove("active");
    endDate.style.display = "block";
    updateScheduleSummary();
  };
  noBtn.onclick  = ()=>{
    noBtn.classList.add("active");
    yesBtn.classList.remove("active");
    endDate.style.display = "none";
    endDate.value = "";
    updateScheduleSummary();
  };
}

document.querySelectorAll(".service-acc").forEach(acc => {
  const header = acc.querySelector(".acc-header");
  const body   = acc.querySelector(".acc-body");

  if (!header || !body) return;

  header.addEventListener("click", () => {
    const isOpen = acc.classList.contains("open");
    if (isOpen){
      acc.classList.remove("open");
      body.style.maxHeight = 0;
    } else {
      acc.classList.add("open");
      body.style.maxHeight = body.scrollHeight + "px";
    }
  });

  body.querySelectorAll("input, select, textarea").forEach(el => {
    el.addEventListener("change", () => {
      updateScheduleSummary();
    });
  });
});

function updateScheduleSummary() {
  const params = new URLSearchParams();
  params.append("mode", inputMode.value || "");

  if (inputMode.value === "same") {
    params.append("date", inputDate.value || "");
    params.append("time_window", inputWindow.value || "");
    params.append("frequency", inputFreq.value || "");
    params.append("weekday", document.getElementById("day_work_best").value);

    const days = Array.from(document.querySelectorAll(".day-check input:checked"))
                      .map(c => c.dataset.day);
    params.append("days", JSON.stringify(days));
  } else {
    const schedules = {};
    document.querySelectorAll(".service-acc").forEach(acc => {
      const slug = acc.dataset.service;

      const date = acc.querySelector(".svc-date").value || "";
      const time = acc.querySelector(".svc-time").value || "";
      const freq = acc.querySelector(".svc-frequency").value || "";
      const notes = acc.querySelector(".svc-notes").value || "";
      const endDate = acc.querySelector(".svc-end-date").value || "";

      const days = Array.from(acc.querySelectorAll(".svc-day:checked"))
                        .map(el => el.value);

      schedules[slug] = {
        date,
        time_window: time,
        frequency: freq,
        days,
        end_date: endDate,
        special_request: notes
      };
    });

    params.append("schedules_json", JSON.stringify(schedules));
  }

  fetch(`/private/api/booking/{{ booking.id }}/price/?` + params.toString())
    .then(res => res.json())
    .then(data => {
      document.getElementById("sum_services").textContent = "$" + Number(data.services_total).toFixed(2);
      document.getElementById("sum_addons").textContent = "$" + Number(data.addons_total).toFixed(2);
      document.getElementById("sum_schedule").textContent = "$" + Number(data.schedule_extra).toFixed(2);
      document.getElementById("sum_rot").textContent = "$" + Number(data.rot).toFixed(2);
      document.getElementById("sum_total").textContent = "$" + Number(data.final).toFixed(2);
    })
    .catch(err => console.error("SUMMARY ERROR:", err));
}

document.getElementById("scheduleForm").addEventListener("submit", function(e){
  const notify = (msg) => {
    if (window.showToast) {
      window.showToast("Missing information", msg);
    } else {
      alert(msg);
    }
  };

  const clearErrors = () => {
    document.querySelectorAll(".field-error").forEach(el => el.classList.remove("field-error"));
    document.querySelectorAll(".field-error-pill").forEach(el => el.classList.remove("field-error-pill"));
    document.querySelectorAll(".time-option.error").forEach(el => el.classList.remove("error"));
  };

  clearErrors();

  if ({{ services|length }} > 1 && !inputMode.value){
    e.preventDefault();
    notify("Please choose how you would like to schedule your services.");
    return;
  }

  if (inputMode.value === "same"){
    let valid = true;

    if (!inputDate.value) {
      valid = false;
      document.querySelectorAll(".day").forEach(el => {
        if (el.classList.contains("selected")) el.classList.remove("selected");
      });
      if (calendarDays) calendarDays.classList.add("field-error-pill");
    }

    if (!inputWindow.value) {
      valid = false;
      const timeBox = document.querySelector(".time-box");
      if (timeBox) timeBox.classList.add("field-error-pill");
    }

    if (!inputFreq.value) {
      valid = false;
      const freqWrap = document.querySelector(".freq-row");
      if (freqWrap) freqWrap.classList.add("field-error-pill");
    }

    const dayChecks = Array.from(document.querySelectorAll(".day-check input:checked"));
    if (!dayChecks.length) {
      valid = false;
      const daysWrap = document.getElementById("weekDays");
      if (daysWrap) daysWrap.classList.add("field-error-pill");
    }

    if (!valid) {
      e.preventDefault();
      notify("Please complete the scheduling details before continuing.");
      return;
    }

    const specialText = document.getElementById("specialRequest")
      ? document.getElementById("specialRequest").value || ""
      : "";

    const days = Array.from(
      document.querySelectorAll(".day-check input:checked")
    ).map(chk => chk.dataset.day);

    document.getElementById("day_work_best").value = JSON.stringify(days);

    const endVal = endDate ? (endDate.value || null) : null;
    const endType = (yesBtn && yesBtn.classList.contains("active") && endVal)
      ? "end_on"
      : "no_end";

    const endInput = document.getElementById("End_Date");
    if (endInput) endInput.value = endVal || "";

    const payload = {
      special_request: specialText,
      days: days,
      end_type: endType,
      end_date: endVal
    };

    inputSpecial.value = JSON.stringify(payload);
  } else if (inputMode.value === "per_service") {
    let valid = true;
    let firstInvalid = null;

    document.querySelectorAll(".service-acc").forEach(acc => {
      const dateEl   = acc.querySelector(".svc-date");
      const timeEl   = acc.querySelector(".svc-time");
      const freqEl   = acc.querySelector(".svc-frequency");
      const daysWrap = acc.querySelector(".svc-days");
      const dayChecks= acc.querySelectorAll(".svc-day:checked");

      if (!dateEl.value) {
        valid = false;
        dateEl.classList.add("field-error");
        firstInvalid = firstInvalid || acc;
      }

      if (!timeEl.value) {
        valid = false;
        timeEl.classList.add("field-error");
        firstInvalid = firstInvalid || acc;
      }

      if (!freqEl.value) {
        valid = false;
        freqEl.classList.add("field-error");
        firstInvalid = firstInvalid || acc;
      }

      if (!dayChecks.length) {
        valid = false;
        if (daysWrap) daysWrap.classList.add("field-error-pill");
        firstInvalid = firstInvalid || acc;
      }
    });

    if (!valid) {
      e.preventDefault();
      if (firstInvalid) {
        firstInvalid.classList.add("open");
        const body = firstInvalid.querySelector(".acc-body");
        if (body) body.style.maxHeight = body.scrollHeight + "px";
        firstInvalid.scrollIntoView({ behavior: "smooth", block: "center" });
      }
      notify("Please complete all schedule fields for each service.");
      return;
    }

    const schedules = {};

    document.querySelectorAll(".service-acc").forEach(acc => {
      const slug = acc.getAttribute("data-service");
      if (!slug) return;

      const dateEl   = acc.querySelector(".svc-date");
      const timeEl   = acc.querySelector(".svc-time");
      const freqEl   = acc.querySelector(".svc-frequency");
      const notesEl  = acc.querySelector(".svc-notes");
      const endEl    = acc.querySelector(".svc-end-date");
      const dayChecks= acc.querySelectorAll(".svc-day:checked");

      const days = Array.from(dayChecks).map(ch => ch.value);

      const dateVal = dateEl ? (dateEl.value || null) : null;
      const timeVal = timeEl ? (timeEl.value || "") : "";
      const freqVal = freqEl ? (freqEl.value || "") : "";
      const notesVal= notesEl ? (notesEl.value || "") : "";
      const endVal  = endEl ? (endEl.value || null) : null;

      schedules[slug] = {
        date: dateVal,
        time_window: timeVal,
        frequency: freqVal,
        days: days,
        end_date: endVal,
        special_request: notesVal
      };
    });

    inputSchedulesJson.value = JSON.stringify(schedules);

    inputDate.value = "";
    inputWindow.value = "";
    inputFreq.value = "";
    inputSpecial.value = "";
    document.getElementById("day_work_best").value = "";
    document.getElementById("End_Date").value = "";
  }
});

document.addEventListener("DOMContentLoaded", () => {
  updateScheduleSummary();
});
</script>

<script src="{% static 'js/main_header.js' %}"></script>
{% include "home/includes/footer.html" %}
</body>
</html>
